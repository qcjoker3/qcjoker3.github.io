<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calculatrice de Retraite</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>Calculatrice de Retraite</h1>
  <nav>
    <a href="#personnel">Informations personnelles</a>
    <a href="#comptes">Comptes & Rendements</a>
    <a href="#evenements">Événements financiers</a>
    <a href="#resultats">Résultats</a>
  </nav>
</header>

<div class="container">

  <!-- Informations personnelles -->
  <section id="personnel" class="card">
    <h2>Informations personnelles</h2>
    <div class="form-group">
      <label for="ageActuel">Âge actuel</label>
      <input type="number" id="ageActuel" value="40">
    </div>
    <div class="form-group">
      <label for="ageRetraite">Âge de retraite souhaité</label>
      <input type="number" id="ageRetraite" value="65">
    </div>
    <div class="form-group">
      <label for="salaireActuel">Salaire actuel annuel</label>
      <input type="number" id="salaireActuel" value="100000">
    </div>
    <div class="form-group">
      <label>Revenu désiré à la retraite</label>
      <div>
        <input type="radio" name="revenuType" value="70" checked> 70%
        <input type="radio" name="revenuType" value="80"> 80%
        <input type="radio" name="revenuType" value="manuel"> Manuel
      </div>
      <input type="number" id="revenuManuel" placeholder="Montant annuel" style="display:none;">
    </div>
  </section>

  <!-- Comptes & rendements -->
  <section id="comptes" class="card">
    <h2>Comptes & Rendements</h2>
    <div class="form-group">
      <label for="montantCELI">Montant CELI</label>
      <input type="number" id="montantCELI" value="50000">
    </div>
    <div class="form-group">
      <label for="cotisationCELI">Cotisation annuelle CELI</label>
      <input type="number" id="cotisationCELI" value="6000">
    </div>
    <div class="form-group">
      <label for="rendementCELI">Rendement annuel CELI (%)</label>
      <input type="number" id="rendementCELI" value="5">
    </div>

    <div class="form-group">
      <label for="montantREER">Montant REER</label>
      <input type="number" id="montantREER" value="150000">
    </div>
    <div class="form-group">
      <label for="cotisationREER">Cotisation annuelle REER</label>
      <input type="number" id="cotisationREER" value="18000">
    </div>
    <div class="form-group">
      <label for="rendementREER">Rendement annuel REER (%)</label>
      <input type="number" id="rendementREER" value="5">
    </div>

    <div class="form-group">
      <label for="montantCRI">Montant CRI</label>
      <input type="number" id="montantCRI" value="80000">
    </div>
    <div class="form-group">
      <label for="cotisationCRI">Cotisation annuelle CRI</label>
      <input type="number" id="cotisationCRI" value="5000">
    </div>
    <div class="form-group">
      <label for="rendementCRI">Rendement annuel CRI (%)</label>
      <input type="number" id="rendementCRI" value="4">
    </div>

    <div class="form-group">
      <label for="montantNonEnregistre">Montant Non Enregistré</label>
      <input type="number" id="montantNonEnregistre" value="20000">
    </div>
    <div class="form-group">
      <label for="cotisationNonEnregistre">Cotisation annuelle Non Enregistrée</label>
      <input type="number" id="cotisationNonEnregistre" value="5000">
    </div>
    <div class="form-group">
      <label for="rendementNonEnregistre">Rendement annuel Non Enregistré (%)</label>
      <input type="number" id="rendementNonEnregistre" value="4">
    </div>
  </section>

  <!-- Événements financiers -->
  <section id="evenements" class="card">
    <h2>Événements financiers</h2>
    <table id="tableEvenements">
      <thead>
        <tr>
          <th>Année</th>
          <th>Montant</th>
          <th>Type de compte</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="form-group">
      <input type="number" id="evtAnnee" placeholder="Année">
      <input type="number" id="evtMontant" placeholder="Montant">
      <select id="evtCompte">
        <option value="auto">Automatique</option>
        <option value="CELI">CELI</option>
        <option value="REER">REER</option>
        <option value="CRI">CRI</option>
        <option value="NonEnregistre">Non Enregistré</option>
      </select>
      <button class="btn-primary" id="ajoutEvenement">Ajouter</button>
    </div>
  </section>

  <!-- Résultats -->
  <section id="resultats" class="card">
    <h2>Résultats</h2>
    <div id="totalCapitalCard">
      <h2>Total restant: $<span id="totalRestant">0</span></h2>
      <h3>Impôt payé total: $<span id="impotTotal">0</span></h3>
    </div>
    <div class="scenario-btns">
      <button class="scenario-btn active" data-scenario="maxDuree">Maximiser durée</button>
      <button class="scenario-btn" data-scenario="minImpot">Minimiser impôt</button>
      <button class="scenario-btn" data-scenario="esperance">Espérance de vie</button>
    </div>
    <canvas id="graphique"></canvas>
    <table id="tableResultats">
      <thead>
        <tr>
          <th>Année</th>
          <th>CELI</th>
          <th>REER</th>
          <th>CRI</th>
          <th>Non Enregistré</th>
          <th>Total</th>
          <th>Impôt payé</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <button class="btn-primary" id="calculer">Calculer</button>
</div>

<script>
/* =======================
   LOGIQUE JAVASCRIPT
   ======================= */

document.addEventListener('DOMContentLoaded', () => {
  const revenuRadios = document.getElementsByName('revenuType');
  const revenuManuelInput = document.getElementById('revenuManuel');
  revenuRadios.forEach(r => {
    r.addEventListener('change', () => {
      if(r.value === 'manuel') revenuManuelInput.style.display = 'block';
      else revenuManuelInput.style.display = 'none';
    });
  });

  const evenements = [];
  const tableEvtBody = document.querySelector('#tableEvenements tbody');

  document.getElementById('ajoutEvenement').addEventListener('click', () => {
    const annee = parseInt(document.getElementById('evtAnnee').value);
    const montant = parseFloat(document.getElementById('evtMontant').value);
    const compte = document.getElementById('evtCompte').value;
    if(!annee || !montant) return;
    const evt = {annee, montant, compte};
    evenements.push(evt);

    const row = document.createElement('tr');
    row.innerHTML = `<td>${annee}</td><td>${montant.toLocaleString()}</td><td>${compte}</td><td><button class="btn-primary supprimer">X</button></td>`;
    tableEvtBody.appendChild(row);
    row.querySelector('.supprimer').addEventListener('click', () => {
      tableEvtBody.removeChild(row);
      const index = evenements.indexOf(evt);
      if(index>-1) evenements.splice(index,1);
    });
  });

  const scenarioBtns = document.querySelectorAll('.scenario-btn');
  scenarioBtns.forEach(btn => btn.addEventListener('click', () => {
    scenarioBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }));

  const ctx = document.getElementById('graphique').getContext('2d');
  let chartInstance = null;

  document.getElementById('calculer').addEventListener('click', () => {
    // Récupération des données
    const ageActuel = parseInt(document.getElementById('ageActuel').value);
    const ageRetraite = parseInt(document.getElementById('ageRetraite').value);
    const salaireActuel = parseFloat(document.getElementById('salaireActuel').value);

    let revenuType = document.querySelector('input[name="revenuType"]:checked').value;
    let revenuAnnuel = revenuType === 'manuel' ? parseFloat(revenuManuelInput.value) : salaireActuel*(parseFloat(revenuType)/100);

    const comptes = {
      CELI: {montant: parseFloat(document.getElementById('montantCELI').value), cotisation: parseFloat(document.getElementById('cotisationCELI').value), rendement: parseFloat(document.getElementById('rendementCELI').value)/100},
      REER: {montant: parseFloat(document.getElementById('montantREER').value), cotisation: parseFloat(document.getElementById('cotisationREER').value), rendement: parseFloat(document.getElementById('rendementREER').value)/100},
      CRI: {montant: parseFloat(document.getElementById('montantCRI').value), cotisation: parseFloat(document.getElementById('cotisationCRI').value), rendement: parseFloat(document.getElementById('rendementCRI').value)/100},
      NonEnregistre: {montant: parseFloat(document.getElementById('montantNonEnregistre').value), cotisation: parseFloat(document.getElementById('cotisationNonEnregistre').value), rendement: parseFloat(document.getElementById('rendementNonEnregistre').value)/100}
    };

    const scenario = document.querySelector('.scenario-btn.active').dataset.scenario;

    // Calcul année par année
    const data = [];
    const maxAge = scenario==='esperance' ? ageActuel+30 : ageActuel+40; // simplification
    let totalImpots = 0;

    for(let age=ageActuel; age<=maxAge; age++){
      const yearData = {age};
      let total=0, impots=0;
      for(let key in comptes){
        let c = comptes[key];
        if(age<ageRetraite) c.montant += c.cotisation;
        c.montant = c.montant*(1+c.rendement);
        yearData[key] = Math.round(c.montant);
        total+=c.montant;
      }

      // Appliquer événements financiers
      evenements.filter(e=>e.annee===age).forEach(e=>{
        if(e.compte==='auto'){
          // répartir de manière proportionnelle
          let totalMontant = Object.values(comptes).reduce((sum,c)=>sum+ c.montant,0);
          for(let k in comptes) comptes[k].montant += (comptes[k].montant/totalMontant)*e.montant;
        } else comptes[e.compte].montant += e.montant;
      });

      yearData.total = Math.round(total);
      yearData.impot = Math.round(impots);
      totalImpots += impots;
      data.push(yearData);
    }

    // Affichage total
    document.getElementById('totalRestant').textContent = Math.round(data[data.length-1].total).toLocaleString();
    document.getElementById('impotTotal').textContent = Math.round(totalImpots).toLocaleString();

    // Remplissage tableau
    const tbodyRes = document.querySelector('#tableResultats tbody');
    tbodyRes.innerHTML='';
    data.forEach(d=>{
      if(d.CELI===0 && d.REER===0 && d.CRI===0 && d.NonEnregistre===0) return;
      const row = document.createElement('tr');
      row.innerHTML = `<td>${d.age}</td><td>${d.CELI.toLocaleString()}</td><td>${d.REER.toLocaleString()}</td><td>${d.CRI.toLocaleString()}</td><td>${d.NonEnregistre.toLocaleString()}</td><td>${d.total.toLocaleString()}</td><td>${d.impot.toLocaleString()}</td>`;
      tbodyRes.appendChild(row);
    });

    // Graphique
    const labels = data.map(d=>d.age);
    const datasets = [
      {label:'CELI', data:data.map(d=>d.CELI), backgroundColor:'rgba(0,196,140,0.4)', borderColor:'rgba(0,196,140,0.8)'},
      {label:'REER', data:data.map(d=>d.REER), backgroundColor:'rgba(26,115,232,0.4)', borderColor:'rgba(26,115,232,0.8)'},
      {label:'CRI', data:data.map(d=>d.CRI), backgroundColor:'rgba(255,193,7,0.4)', borderColor:'rgba(255,193,7,0.8)'},
      {label:'NonEnregistre', data:data.map(d=>d.NonEnregistre), backgroundColor:'rgba(220,53,69,0.4)', borderColor:'rgba(220,53,69,0.8)'}
    ];

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type:'bar',
      data:{labels, datasets},
      options:{responsive:true, scales:{y:{beginAtZero:true}}}
    });
  });
});
</script>
</body>
</html>
