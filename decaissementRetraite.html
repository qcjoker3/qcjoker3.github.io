<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculatrice Décaissement Optimisée</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
<h1>Calculatrice de Décaissement Optimisée</h1>

<div class="card" id="totalCapitalCard">
  <h2>Total restant: <span id="totalCapital">$0</span></h2>
  <div class="progress-bar"><div id="progress" style="width:0%"></div></div>
</div>

<div class="card-grid">
  <div class="card">
    <h3>Informations personnelles</h3>
    <div class="form-group"><label>Âge actuel</label><input type="number" id="age" value="65"></div>
    <div class="form-group"><label>Âge de la retraite</label><input type="number" id="ageRetraite" value="65"></div>
    <div class="form-group"><label>Sexe</label><select id="sexe"><option value="H">Homme</option><option value="F">Femme</option></select></div>
    <div class="form-group"><label>Espérance de vie</label><select id="lifeExpectancy"><option value="75">Courte</option><option value="85" selected>Moyenne</option><option value="100">Longue</option></select></div>
  </div>

  <div class="card">
    <h3>Comptes et rendements (%)</h3>
    <div class="form-group"><label>CELI ($)</label><input type="number" id="celi" value="50000"></div>
    <div class="form-group"><label>Rendement CELI</label><input type="number" id="celiRendement" value="5" step="0.1"></div>
    <div class="form-group"><label>REER/FERR ($)</label><input type="number" id="reer" value="150000"></div>
    <div class="form-group"><label>Rendement REER</label><input type="number" id="reerRendement" value="6" step="0.1"></div>
    <div class="form-group"><label>CRI/FRV ($)</label><input type="number" id="cri" value="80000"></div>
    <div class="form-group"><label>Rendement CRI</label><input type="number" id="criRendement" value="4" step="0.1"></div>
    <div class="form-group"><label>Non-enregistré ($)</label><input type="number" id="nonEnregistre" value="0"></div>
    <div class="form-group"><label>Rendement Non-enregistré</label><input type="number" id="nonRendement" value="3" step="0.1"></div>
  </div>

  <div class="card">
    <h3>Revenu désiré</h3>
    <div class="form-group"><label>Montant</label><input type="number" id="revenu" value="30000"></div>
    <div class="form-group"><label>Fréquence</label><select id="frequence"><option value="annuel">Annuel</option><option value="mensuel">Mensuel</option></select></div>
  </div>

  <div class="card">
    <h3>RRQ & PSV</h3>
    <div class="form-group"><label>RRQ: âge début</label><input type="number" id="rrqAge" value="65"></div>
    <div class="form-group"><label>RRQ: montant à 65</label><input type="number" id="rrqMontant" value="12000"></div>
    <div class="form-group"><label>PSV: âge début</label><input type="number" id="psvAge" value="65"></div>
    <div class="form-group"><label>PSV: montant à 65</label><input type="number" id="psvMontant" value="7800"></div>
  </div>
</div>

<div class="scenario-btns">
  <button class="scenario-btn scenario1 active" data-scenario="1">Maximiser durée</button>
  <button class="scenario-btn scenario2" data-scenario="2">Minimiser impôt</button>
  <button class="scenario-btn scenario3" data-scenario="3">Espérance choisie</button>
</div>

<div class="card">
  <h3>Événements financiers</h3>
  <table id="events-table">
    <thead><tr><th>Année</th><th>Type</th><th>Montant</th><th>Action</th></tr></thead>
    <tbody id="events-body"></tbody>
  </table>
  <button class="btn-primary" id="addEvent">Ajouter un événement</button>
</div>

<canvas id="decaissChart" height="200"></canvas>
</div>

<script>
const ctx = document.getElementById('decaissChart').getContext('2d');
let chart = null;
let events = [];

document.getElementById('addEvent').addEventListener('click', () => {
  const tbody = document.getElementById('events-body');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="number" class="event-year" value="2030"></td>
    <td>
      <select class="event-type">
        <option value="ajout">Ajout</option>
        <option value="depense">Dépense</option>
      </select>
    </td>
    <td><input type="number" class="event-montant" value="0"></td>
    <td><button class="remove-btn">Supprimer</button></td>
  `;
  tbody.appendChild(tr);
  tr.querySelector('.remove-btn').addEventListener('click', () => { tr.remove(); simulate(); });
  tr.querySelectorAll('input, select').forEach(el => el.addEventListener('input', simulate));
});

let currentScenario = 1;
document.querySelectorAll('.scenario-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentScenario = parseInt(btn.dataset.scenario);
    simulate();
  });
});

function simulate() {
  const age = parseInt(document.getElementById('age').value);
  const ageRetraite = parseInt(document.getElementById('ageRetraite').value);
  const expectancy = parseInt(document.getElementById('lifeExpectancy').value);

  let celiBal = parseFloat(document.getElementById('celi').value);
  const celiRend = parseFloat(document.getElementById('celiRendement').value)/100;
  let reerBal = parseFloat(document.getElementById('reer').value);
  const reerRend = parseFloat(document.getElementById('reerRendement').value)/100;
  let criBal = parseFloat(document.getElementById('cri').value);
  const criRend = parseFloat(document.getElementById('criRendement').value)/100;
  let nonBal = parseFloat(document.getElementById('nonEnregistre').value);
  const nonRend = parseFloat(document.getElementById('nonRendement').value)/100;

  const revenuInput = parseFloat(document.getElementById('revenu').value);
  const frequence = document.getElementById('frequence').value;
  const revenu = frequence==='mensuel'? revenuInput*12 : revenuInput;

  const rrqAge = parseInt(document.getElementById('rrqAge').value);
  const rrqMontant = parseFloat(document.getElementById('rrqMontant').value);
  const psvAge = parseInt(document.getElementById('psvAge').value);
  const psvMontant = parseFloat(document.getElementById('psvMontant').value);

  events = [];
  document.querySelectorAll('#events-body tr').forEach(tr=>{
    const annee = parseInt(tr.querySelector('.event-year').value);
    const type = tr.querySelector('.event-type').value;
    const montant = parseFloat(tr.querySelector('.event-montant').value);
    events.push({annee,type,montant});
  });

  const years=[];
  for(let y=ageRetraite;y<=expectancy;y++) years.push(y);

  const celiArr=[],reerArr=[],criArr=[],nonArr=[],totalArr=[];

  let droitsCELI = 0;

  years.forEach(year=>{
    let revenuAnnuel = revenu;
    if(year>=rrqAge) revenuAnnuel+=rrqMontant;
    if(year>=psvAge) revenuAnnuel+=psvMontant;

    events.forEach(e=>{if(e.annee===year) revenuAnnuel += e.type==='ajout'? e.montant : -e.montant;});

    [celiBal,reerBal,criBal,nonBal] = retraitStrategiqueOptimise([celiBal,reerBal,criBal,nonBal],revenuAnnuel,currentScenario,droitsCELI);

    celiBal *= 1+celiRend; reerBal *= 1+reerRend; criBal *= 1+criRend; nonBal *= 1+nonRend;

    celiArr.push(celiBal); reerArr.push(reerBal); criArr.push(criBal); nonArr.push(nonBal);
    totalArr.push(celiBal+reerBal+criBal+nonBal);
  });

  const totalCapital = totalArr[totalArr.length-1];
  document.getElementById('totalCapital').textContent = `$${totalCapital.toLocaleString()}`;
  const progressPercent = Math.max(0,Math.min(100,(totalCapital/(celiBal+reerBal+criBal+nonBal+revenu))*100));
  document.getElementById('progress').style.width = progressPercent + '%';

  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:'bar',
    data:{
      labels:years,
      datasets:[
        {label:'CELI',data:celiArr,backgroundColor:'rgba(0,196,140,0.5)',stack:'Stack0'},
        {label:'REER/FERR',data:reerArr,backgroundColor:'rgba(26,115,232,0.5)',stack:'Stack0'},
        {label:'CRI/FRV',data:criArr,backgroundColor:'rgba(255,193,7,0.5)',stack:'Stack0'},
        {label:'Non-enregistré',data:nonArr,backgroundColor:'rgba(220,53,69,0.5)',stack:'Stack0'},
        {label:'Total',data:totalArr,type:'line',borderColor:'#0a2540',borderWidth:2,fill:false}
      ]
    },
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      plugins:{title:{display:true,text:'Simulation Décaissement'}},
      scales:{y:{beginAtZero:true}}
    }
  });
}

// Retrait stratégique avancé
function retraitStrategiqueOptimise(balances,montant,scenario,droitsCELI=0){
  let [celi,reer,cri,nonE]=balances;
  let ordre=[];
  if(scenario===1) ordre=[3,0,2,1];
  else if(scenario===2) ordre=[0,3,2,1];
  else if(scenario===3) ordre=[3,0,2,1];

  for(let i of ordre){
    if(montant<=0) break;
    let solde=[celi,reer,cri,nonE][i];
    let retrait=Math.min(solde,montant);
    if(i===0){ celi-=retrait; montant-=retrait; droitsCELI+=retrait; }
    else if(i===1){ reer-=retrait; montant-=retrait; }
    else if(i===2){ cri-=retrait; montant-=retrait; }
    else if(i===3){ 
      nonE-=retrait; montant-=retrait;
      if(droitsCELI>0){
        let transfert=Math.min(retrait,droitsCELI);
        celi+=transfert; nonE-=transfert; droitsCELI-=transfert;
      }
    }
  }
  return [celi,reer,cri,nonE];
}

document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input',simulate));
simulate();
</script>
</body>
</html>
