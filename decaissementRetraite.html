<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculatrice Retraite</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .card {
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    label { flex:1 0 120px; }
    input { flex:1 0 100px; padding:4px; }
    .btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; background:#eee; }
    .btn:hover { background:#ddd; }
    .scenario-btn.active { background:#007bff; color:white; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th { background:#f0f0f0; }
    canvas { max-width:100%; height:300px; }
    @media(max-width:900px){ .grid{ grid-template-columns:repeat(2,1fr);} }
    @media(max-width:600px){ .grid{ grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <h1>Calculatrice d'Épargne et Décaissement Retraite</h1>

  <!-- 6 cartes en 2x3 -->
  <div class="grid">
    <div class="card"><h3>Profil</h3>
      <div class="row"><label>Âge actuel :</label><input type="number" id="age" value="40"></div>
      <div class="row"><label>Âge retraite :</label><input type="number" id="ageRet" value="65"></div>
      <div class="row"><label>Espérance de vie :</label><input type="number" id="espVie" value="90"></div>
    </div>
    <div class="card"><h3>Soldes actuels</h3>
      <div class="row"><label>REER :</label><input type="number" id="soldeReer" value="50000"></div>
      <div class="row"><label>CELI :</label><input type="number" id="soldeCeli" value="20000"></div>
      <div class="row"><label>Non enregistré :</label><input type="number" id="soldeNonReg" value="10000"></div>
    </div>
    <div class="card"><h3>Cotisations annuelles</h3>
      <div class="row"><label>REER :</label><input type="number" id="cotReer" value="6000"></div>
      <div class="row"><label>CELI :</label><input type="number" id="cotCeli" value="6000"></div>
      <div class="row"><label>Non enregistré :</label><input type="number" id="cotNonReg" value="2000"></div>
    </div>
    <div class="card"><h3>Rendements</h3>
      <div class="row"><label>Rendement annuel (%) :</label><input type="number" id="tauxRend" value="5"></div>
      <div class="row"><label>Inflation (%) :</label><input type="number" id="inflation" value="2"></div>
    </div>
    <div class="card"><h3>RRQ & PSV</h3>
      <div class="row"><label>RRQ/mois :</label><input type="number" id="rrq" value="900"></div>
      <div class="row"><label>PSV/mois :</label><input type="number" id="psv" value="600"></div>
    </div>
    <div class="card"><h3>Fonds de pension</h3>
      <div class="row"><label>Rente annuelle :</label><input type="number" id="pension" value="8000"></div>
    </div>
  </div>

  <!-- boutons -->
  <div class="row" style="margin-top:16px">
    <button class="btn" id="btnCalc">Calculer</button>
    <div id="scenarioButtons" style="display:flex;gap:6px">
      <button class="btn scenario-btn active" data-scenario="duree">Durée (max années)</button>
      <button class="btn scenario-btn" data-scenario="impot">Impôt min</button>
      <button class="btn scenario-btn" data-scenario="espvie">Espérance de vie</button>
    </div>
  </div>

  <!-- résultats -->
  <div id="results" style="margin-top:20px">
    <h2>Résultats</h2>
    <div id="tables"></div>
    <canvas id="chart"></canvas>
  </div>

<script>
const $ = id=>document.getElementById(id);
let currentScenario="duree"; 
let chart;

// écouteur boutons scénario
document.querySelectorAll('.scenario-btn').forEach(btn=>{
  btn.addEventListener('click', e=>{
    currentScenario=e.target.dataset.scenario;
    document.querySelectorAll('.scenario-btn').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    renderScenario(currentScenario);
  });
});

$('btnCalc').addEventListener('click', ()=>simulate());

// ---- Simulation principale ----
function simulate(){
  const age=+$('age').value, ageRet=+$('ageRet').value, esp=+$('espVie').value;
  const soldeReer=+$('soldeReer').value, soldeCeli=+$('soldeCeli').value, soldeNonReg=+$('soldeNonReg').value;
  const cotReer=+$('cotReer').value, cotCeli=+$('cotCeli').value, cotNonReg=+$('cotNonReg').value;
  const taux=(+$('tauxRend').value)/100, infl=(+$('inflation').value)/100;
  const rrq=+$('rrq').value*12, psv=+$('psv').value*12, pension=+$('pension').value;

  let years=[];
  let balances=[];
  let soldeR=soldeReer, soldeC=soldeCeli, soldeN=soldeNonReg;

  for(let an=age; an<=esp; an++){
    // capitalisation
    if(an<ageRet){
      soldeR = (soldeR+cotReer)*(1+taux);
      soldeC = (soldeC+cotCeli)*(1+taux);
      soldeN = (soldeN+cotNonReg)*(1+taux);
    }else{
      // retraits = besoins - revenus fixes
      let revenusFixes=rrq+psv+pension;
      let besoin=40000*Math.pow(1+infl, an-ageRet);
      let retrait=Math.max(0, besoin-revenusFixes);
      // retirer dans ordre REER, puis CELI, puis non-reg
      let rest=retrait;
      if(soldeR>0){ let r=Math.min(soldeR,rest); soldeR-=r; rest-=r; }
      if(rest>0 && soldeC>0){ let r=Math.min(soldeC,rest); soldeC-=r; rest-=r; }
      if(rest>0 && soldeN>0){ let r=Math.min(soldeN,rest); soldeN-=r; rest-=r; }
      // croissance résiduelle
      soldeR*=(1+taux);
      soldeC*=(1+taux);
      soldeN*=(1+taux);
    }
    years.push(an);
    balances.push({an, soldeR, soldeC, soldeN});
  }
  window.simData={years, balances};
  renderScenario(currentScenario);
}

// ---- Rendu selon scénario ----
function renderScenario(scn){
  if(!window.simData) return;
  const {years, balances}=window.simData;
  const tables=$('tables');
  tables.innerHTML="";
  let table="<table><thead><tr><th>Âge</th><th>REER</th><th>CELI</th><th>Non enregistré</th><th>Total</th></tr></thead><tbody>";
  balances.forEach(b=>{
    table+=`<tr><td>${b.an}</td><td>${b.soldeR.toFixed(0)}</td><td>${b.soldeC.toFixed(0)}</td><td>${b.soldeN.toFixed(0)}</td><td>${(b.soldeR+b.soldeC+b.soldeN).toFixed(0)}</td></tr>`;
  });
  table+="</tbody></table>";
  tables.innerHTML=table;

  // chart
  if(chart) chart.destroy();
  const ctx=$('chart').getContext('2d');
  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:years,
      datasets:[
        {label:"REER", data:balances.map(b=>b.soldeR), borderColor:"red", fill:false},
        {label:"CELI", data:balances.map(b=>b.soldeC), borderColor:"green", fill:false},
        {label:"Non-reg", data:balances.map(b=>b.soldeN), borderColor:"blue", fill:false}
      ]
    }
  });
}
</script>
</body>
</html>
