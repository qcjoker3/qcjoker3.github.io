<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculatrice - Planification financière</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="container">
    <h1>Finoza</h1>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="#services">Services</a>
        <a href="Prédictions.html">Prédictions</a>
        <a href="calculatrices.html">Calculatrices</a>
        <a href="gestionActive.html">Gestion active</a>
        <a href="decaissementRetraite.html">Décaissement retraite</a>
        <a href="blog.html">Articles</a>
        <a href="#contact">Contact</a>
    </nav>
</header>

  <div class="container">
    <!-- ===== 6 BLOCS HORIZONTAUX ===== -->
    <div class="card-grid">
      <!-- Bloc 1: Infos personne -->
      <div class="card">
        <h3>Profil & inflation</h3>
        <div class="form-group"><label>Âge actuel</label><input type="number" id="ageActuel" value="40" /></div>
        <div class="form-group"><label>Âge de retraite</label><input type="number" id="ageRetraite" value="65" /></div>
        <div class="form-group"><label>Salaire actuel ($/an)</label><input type="number" id="salaireActuel" value="80000" /></div>
        <div class="form-group"><label>Inflation annuelle (%)</label><input type="number" id="inflation" value="2.0" /></div>
        <div class="form-group">
          <label>Revenu désiré à la retraite</label>
          <select id="revenuChoix">
            <option value="70" selected>70% du salaire (indexé)</option>
            <option value="80">80% du salaire (indexé)</option>
            <option value="manuel">Montant manuel (indexé)</option>
          </select>
        </div>
        <div id="revenuManuelGroup" class="form-group" style="display:none">
          <label>Montant annuel (valeur actuelle)</label>
          <input type="number" id="revenuManuel" placeholder="Ex. 55000" />
        </div>
        <div class="form-group">
          <label>Espérance de vie cible</label>
          <select id="esperanceVie">
            <option value="70">Courte (70 ans)</option>
            <option value="85" selected>Moyenne (85 ans)</option>
            <option value="100">Longue (100 ans)</option>
          </select>
        </div>
      </div>

      <!-- Bloc 2: Soldes & cotisations -->
      <div class="card">
        <h3>Soldes actuels</h3>
        <div class="form-group"><label>CELI actuel</label><input type="number" id="celiActuel" value="50000" /></div>
        <div class="form-group"><label>REER actuel</label><input type="number" id="reerActuel" value="120000" /></div>
        <div class="form-group"><label>CRI actuel</label><input type="number" id="criActuel" value="60000" /></div>
        <div class="form-group"><label>Non-enregistré actuel</label><input type="number" id="nonActuel" value="40000" /></div>
      </div>

      <!-- Bloc 3: Rendements -->
      <div class="card">
        <h3>Cotisations</h3>
        <div class="form-group"><label>Cotisation annuelle CELI</label><input type="number" id="celiCot" value="6000" /></div>
        <div class="form-group"><label>Cotisation annuelle REER</label><input type="number" id="reerCot" value="10000" /></div>
        <div class="form-group"><label>Cotisation annuelle CRI</label><input type="number" id="criCot" value="5000" /></div>
        <div class="form-group"><label>Cotisation annuelle Non-enreg.</label><input type="number" id="nonCot" value="0" /></div>
      </div>
      
      <!-- Bloc 4: Rendements -->
      <div class="card">
        <h3>Rendements</h3>
        <div class="form-group"><label>Rendement CELI (%)</label><input type="number" id="celiRend" value="5" /></div>
        <div class="form-group"><label>Rendement REER (%)</label><input type="number" id="reerRend" value="6" /></div>
        <div class="form-group"><label>Rendement CRI (%)</label><input type="number" id="criRend" value="5.5" /></div>
        <div class="form-group"><label>Rendement Non-enreg. (%)</label><input type="number" id="nonRend" value="4" /></div>
      </div>

      <!-- Bloc 5: RRQ & PSV -->
      <div class="card">
        <h3>RRQ & PSV</h3>
        <div class="form-group"><label>RRQ à 65 ans (mensuel)</label><input type="number" id="rrq65" value="1000" /></div>
        <div class="form-group"><label>PSV à 65 ans (mensuel)</label><input type="number" id="psv65" value="800" /></div>
        <div class="form-group"><label>Âge de retrait RRQ</label><input type="number" id="ageRRQ" value="65" /></div>
        <div class="form-group"><label>Âge de retrait PSV</label><input type="number" id="agePSV" value="65" /></div>

        <details class="advanced-options" style="margin-top:10px">
          <summary>Options avancées RRQ/PSV & FRV/FERR</summary>
          <div class="form-section">
            <div class="form-group"><label>RRQ : réduction/mois avant 65 (%)</label><input type="number" id="rrqRedPct" value="0.6" /></div>
            <div class="form-group"><label>RRQ : bonification/mois après 65 (%)</label><input type="number" id="rrqBonPct" value="0.7" /></div>
            <div class="form-group"><label>PSV : seuil de récupération de départ ($)</label><input type="number" id="oasThresholdBase" value="93454" /></div>
            <div class="form-group"><label>Taux de récupération PSV (%)</label><input type="number" id="oasClawRate" value="15" /></div>
            <div class="form-group"><label>Appliquer règles FERR/FRV dès 71 ans</label>
              <select id="applyRrifLif">
                <option value="1" selected>Oui</option>
                <option value="0">Non</option>
              </select>
            </div>
            <div class="form-group"><label>Taux de référence FRV (%)</label><input type="number" id="lifRefRate" value="6" /></div>
          </div>
        </details>
      </div>

      <!-- Bloc 6: Fonds de pension -->
      <div class="card">
        <div class="form-group">
        <h3>Fonds de pension</h3>
          <select id="pensionChoix">
            <option value="oui">Oui</option>
            <option value="non" selected>Non</option>
          </select>
        </div>
        <div id="fondPensionGroup" class="form-group" style="display:none">
          <label>Salaire garanti ($ actuel)</label><input type="number" id="salairePension" value="0" />
          <label>Indexation annuelle (%)</label><input type="number" id="indexPension" value="2" />
        </div>
    </div>
  </div>
  <!-- Fiscalité -->
  <div class="card" style="display:none">
    <h3>Fiscalité (paliers éditables, indexés par inflation)</h3>
    <p class="helper">Listes JSON <code>[[plafond, taux], ...]</code> — plafonds indexés chaque année.</p>
    <div class="card-grid">
      <div class="form-group">
        <label>Fédéral 2025</label>
        <input id="fedBrackets" value='[[55867,0.15],[111733,0.205],[173206,0.26],[246752,0.29],[Infinity,0.33]]' />
      </div>
      <div class="form-group">
        <label>Québec 2025</label>
        <input id="qcBrackets" value='[[51780,0.145],[103545,0.20],[126000,0.24],[Infinity,0.2575]]' />
      </div>
      <div class="form-group">
        <label>Crédit de base combiné ($, optionnel)</label>
        <input id="basicCredit" value="0" />
      </div>
    </div>
  </div>

  <!-- Événements -->
  <div class="card">
    <h3>Événements financiers</h3>
    <div id="evenementsContainer"></div>
    <button id="ajoutEvenement" class="btn-primary" type="button">Ajouter un événement</button>
    <p class="helper">Un événement = âge (année) et montant +/-.</p>
  </div>

  <!-- Scénarios -->
  <div class="card">
    <h3>Scénarios de décaissement</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap";width: 100%;>
      <button class="btn-primary scenario" data-s="durée">Maximiser la durée</button>
      <button class="btn-primary scenario" data-s="impot">Minimiser l’impôt total</button>
      <button class="btn-primary scenario" data-s="espvie">Maximiser les retraits</button>
    </div>
  </div>

  <!-- Résultats & Graphique -->

  <div class="card">
    <h3>Indicateurs</h3>
    <div class="results-dashboard">
      <div class="result-box"><span class="result-label">Capital de fin</span><span class="result-value" id="totalRestant">$0</span></div>
      <div class="result-box"><span class="result-label">Âge d'épuisement du capital</span><span class="result-value" id="ageFin">0</span></div>
      <div class="result-box"><span class="result-label">Impôt cumulé</span><span class="result-value" id="totalImpot">$0</span></div>
      <div class="result-box"><span class="result-label">Dépenses totales</span><span class="result-value" id="depensesCumulees">$0</span></div>
    </div>
  </div>
  
  <div class="card">
    <h3>Valeurs des comptes</h3>
    <div class="chart-container">
      <canvas id="graphiqueSoldes" height="380"></canvas>
    </div>
  </div>


  <div class="card">
    <h3>Table des retraits</h3>
    <div style="max-height:420px;overflow:auto;border-radius:12px">
      <table id="tableauAnnuel"; width: calc(100% / 10);>
        <thead>
          <tr>
            <th>Âge</th>
            <th>Salaire désiré</th>
            <th>Revenus (RRQ+PSV+évén.+)</th>
            <th>Retraits nets</th>
            <th>Impôt</th>
            <th>Retraits bruts</th>
            <th>CELI</th>
            <th>REER</th>
            <th>CRI</th>
            <th>Non-enreg.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
<script>
document.addEventListener("DOMContentLoaded", () => {

  // --- Gestion champs dynamiques ---
  const revenuChoix = document.getElementById("revenuChoix");
  const revenuManuelGroup = document.getElementById("revenuManuelGroup");
  revenuChoix.addEventListener("change", () => {
    revenuManuelGroup.style.display = revenuChoix.value === "manuel" ? "block" : "none";
  });

  const pensionChoix = document.getElementById("pensionChoix");
  const fondPensionGroup = document.getElementById("fondPensionGroup");
  pensionChoix.addEventListener("change", () => {
    fondPensionGroup.style.display = pensionChoix.value === "oui" ? "block" : "none";
  });

  const evenementsContainer = document.getElementById("evenementsContainer");
  document.getElementById("ajoutEvenement").addEventListener("click", () => {
    if (evenementsContainer.children.length >= 4) return;
    const div = document.createElement("div");
    div.className = "form-group";
    div.innerHTML = `
      <input type="number" class="evenementAge" placeholder="Âge">
      <input type="number" class="evenementMontant" placeholder="Montant +/-">
    `;
    evenementsContainer.appendChild(div);
  });

  // --- Permutations 24 décaissements ---
  function permute(array) {
    if (array.length <= 1) return [array];
    const result = [];
    for (let i=0; i<array.length; i++) {
      const rest = array.slice(0,i).concat(array.slice(i+1));
      for (const p of permute(rest)) result.push([array[i], ...p]);
    }
    return result;
  }

  // --- FERR/FRV minimal ---
  function ferrMinimum(solde, age) {
    if (age < 71) return 0;
    return solde / (90 - age);
  }

  // --- Calcul impôt ---
  function calcImpot(revenuAnnuel, brackets) {
    let impot = 0;
    let revenuRestant = revenuAnnuel;
    for (let i=0; i < brackets.length; i++) {
      const [plafond, taux] = brackets[i];
      const prevPlafond = i === 0 ? 0 : brackets[i-1][0];
      const taxable = Math.min(revenuRestant, plafond - prevPlafond);
      if (taxable > 0) impot += taxable * taux;
      revenuRestant -= taxable;
      if (revenuRestant <= 0) break;
    }
    return impot;
  }

  // --- Calcul scénario ---
  function calculerScenario(scenario) {
    const ageActuel = parseInt(document.getElementById("ageActuel").value);
    const ageRetraite = parseInt(document.getElementById("ageRetraite").value);
    const ageMax = 100;
    const inflation = parseFloat(document.getElementById("inflation").value)/100;

    // Soldes initiaux
    let celi = parseFloat(document.getElementById("celiActuel").value);
    let reer = parseFloat(document.getElementById("reerActuel").value);
    let cri = parseFloat(document.getElementById("criActuel").value);
    let non = parseFloat(document.getElementById("nonActuel").value);

    // Cotisations
    const celiCot = parseFloat(document.getElementById("celiCot").value);
    const reerCot = parseFloat(document.getElementById("reerCot").value);
    const criCot = parseFloat(document.getElementById("criCot").value);
    const nonCot = parseFloat(document.getElementById("nonCot").value);

    // Rendements
    const celiRend = parseFloat(document.getElementById("celiRend").value)/100;
    const reerRend = parseFloat(document.getElementById("reerRend").value)/100;
    const criRend = parseFloat(document.getElementById("criRend").value)/100;
    const nonRend = parseFloat(document.getElementById("nonRend").value)/100;

    // RRQ/PSV
    const rrq65 = parseFloat(document.getElementById("rrq65").value);
    const psv65 = parseFloat(document.getElementById("psv65").value);
    const ageRRQ = parseInt(document.getElementById("ageRRQ").value);
    const agePSV = parseInt(document.getElementById("agePSV").value);
    const rrqRedPct = parseFloat(document.getElementById("rrqRedPct").value)/100;
    const rrqBonPct = parseFloat(document.getElementById("rrqBonPct").value)/100;
    const oasThresholdBase = parseFloat(document.getElementById("oasThresholdBase").value);
    const oasClawRate = parseFloat(document.getElementById("oasClawRate").value)/100;
    const applyRrifLif = document.getElementById("applyRrifLif").value==="1";

    // Revenu désiré
    let revenuDesire = revenuChoix.value==="manuel" ? parseFloat(document.getElementById("revenuManuel").value)
      : (parseFloat(revenuChoix.value)/100)*parseFloat(document.getElementById("salaireActuel").value);

    // Événements
    const evenements = [];
    document.querySelectorAll(".evenementAge").forEach((input,i) => {
      const ageEvt = parseInt(input.value);
      const montant = parseFloat(document.querySelectorAll(".evenementMontant")[i].value);
      if(!isNaN(ageEvt) && !isNaN(montant)) evenements.push({age:ageEvt, montant});
    });

    // Impôts
    const fedBrackets = JSON.parse(document.getElementById("fedBrackets").value);
    const qcBrackets = JSON.parse(document.getElementById("qcBrackets").value);

    // Permutations comptes
    const comptes = ["celi","reer","cri","non"];
    const permutations = permute(comptes);

    let meilleurTableau, critereMax;

    permutations.forEach(ordre => {
      // Copier soldes
      let celiTmp = celi, reerTmp = reer, criTmp = cri, nonTmp = non;
      const tableauTmp = [];
      let totalImpot = 0, ageFin = ageMax;

      for (let age=ageActuel; age<=ageMax; age++) {
        // Cotisations avant retraite
        if(age<ageRetraite){celiTmp+=celiCot;reerTmp+=reerCot;criTmp+=criCot;nonTmp+=nonCot;}
        // Rendements
        celiTmp*=1+celiRend; reerTmp*=1+reerRend; criTmp*=1+criRend; nonTmp*=1+nonRend;

        // RRQ/PSV
        let rrq=0, psv=0;
        if(age>=ageRRQ){ rrq = rrq65*12*(ageRRQ<65?1-rrqRedPct*(65-ageRRQ):1+rrqBonPct*(ageRRQ-65)); }
        if(age>=agePSV){ psv = psv65*12; if(psv>oasThresholdBase) psv-=(psv-oasThresholdBase)*oasClawRate; }

        // Revenu désiré indexé
        let revenuIndexe = revenuDesire*(1+inflation)**(age-ageRetraite);

        // Événements
        let evtMontant = evenements.filter(e=>e.age===age).reduce((a,b)=>a+b.montant,0);

        // Retraits FERR/FRV
        let retraitCRIFERR = applyRrifLif ? ferrMinimum(criTmp, age) : 0;
        let retraitREERFERR = applyRrifLif ? ferrMinimum(reerTmp, age) : 0;

        let totalRetrait = revenuIndexe + evtMontant + retraitCRIFERR + retraitREERFERR;

        // Décaissement selon permutation
        let tmpRetrait = totalRetrait;
        const soldeParCompte = {celi: celiTmp, reer: reerTmp, cri: criTmp, non: nonTmp};
        ordre.forEach(comp => {
          const retrait = Math.min(tmpRetrait, soldeParCompte[comp]);
          soldeParCompte[comp]-=retrait;
          tmpRetrait-=retrait;
        });

        // Impôts
        let impFédéral = calcImpot(totalRetrait, fedBrackets);
        let impQC = calcImpot(totalRetrait, qcBrackets);
        totalImpot += impFédéral + impQC;

        tableauTmp.push({
          age,
          celi: soldeParCompte.celi,
          reer: soldeParCompte.reer,
          cri: soldeParCompte.cri,
          non: soldeParCompte.non,
          retraitNet: totalRetrait-(impFédéral+impQC),
          impôtTotal: (impFédéral+impQC),
          revenus: rrq+psv+evtMontant,
          retraitBrut: totalRetrait
        });

        if(soldeParCompte.celi+soldeParCompte.reer+soldeParCompte.cri+soldeParCompte.non<=0 && ageFin===ageMax){
          ageFin = age;
        }
      }

      // Choix meilleur permutation
      if(scenario==="durée"){ if(!critereMax || ageFin>critereMax){ critereMax=ageFin; meilleurTableau=tableauTmp; } }
      else if(scenario==="impot"){ if(!critereMax || totalImpot<critereMax){ critereMax=totalImpot; meilleurTableau=tableauTmp; } }
      else if(scenario==="espvie"){ const dernierSolde = tableauTmp[tableauTmp.length-1].celi+tableauTmp[tableauTmp.length-1].reer+tableauTmp[tableauTmp.length-1].cri+tableauTmp[tableauTmp.length-1].non; if(!critereMax || dernierSolde<critereMax){ critereMax=dernierSolde; meilleurTableau=tableauTmp; } }
    });

    // --- Affichage tableau HTML ---
    const tbody = document.querySelector("#tableauAnnuel tbody");
    tbody.innerHTML = "";
    meilleurTableau.forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.age}</td>
        <td>${(l.retraitBrut-l.revenus).toFixed(2)}</td>
        <td>${l.revenus.toFixed(2)}</td>
        <td>${l.retraitNet.toFixed(2)}</td>
        <td>${l.impôtTotal.toFixed(2)}</td>
        <td>${l.retraitBrut.toFixed(2)}</td>
        <td>${l.celi.toFixed(2)}</td>
        <td>${l.reer.toFixed(2)}</td>
        <td>${l.cri.toFixed(2)}</td>
        <td>${l.non.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

    // --- Graphique ---
    const ctx = document.getElementById("graphiqueSoldes").getContext("2d");
    if(window.graphique) window.graphique.destroy();
    window.graphique = new Chart(ctx, {
      type:"line",
      data:{
        labels: meilleurTableau.map(l=>l.age),
        datasets:[
          {label:"CELI", data: meilleurTableau.map(l=>l.celi), borderColor:"blue", fill:false},
          {label:"REER", data: meilleurTableau.map(l=>l.reer), borderColor:"green", fill:false},
          {label:"CRI/FERR", data: meilleurTableau.map(l=>l.cri), borderColor:"red", fill:false},
          {label:"Non-enregistré", data: meilleurTableau.map(l=>l.non), borderColor:"orange", fill:false}
        ]
      }
    });

    // --- Indicateurs ---
    const dernier = meilleurTableau[meilleurTableau.length-1];
    document.getElementById("totalRestant").textContent = `$${(dernier.celi+dernier.reer+dernier.cri+dernier.non).toFixed(2)}`;
    document.getElementById("ageFin").textContent = dernier.age;
    document.getElementById("totalImpot").textContent = `$${meilleurTableau.reduce((a,b)=>a+parseFloat(b.impôtTotal),0).toFixed(2)}`;
    document.getElementById("depensesCumulees").textContent = `$${meilleurTableau.reduce((a,b)=>a+parseFloat(b.retraitNet),0).toFixed(2)}`;
  }

  // --- Déclencheur boutons scénarios ---
  document.querySelectorAll(".scenario").forEach(btn => {
    btn.addEventListener("click", () => {
      const scenario = btn.dataset.s;
      calculerScenario(scenario);
    });
  });

});
</script>
</body>
</html>
