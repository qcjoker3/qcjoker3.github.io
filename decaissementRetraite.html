<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calculatrice Décaissement - Prototype avec Revenu</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #fafafa;
  }
  h1 {
    text-align: center;
  }
  .form-section {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    font-weight: bold;
  }
  input, select {
    padding: 5px;
    width: 150px;
  }
  canvas {
    background: white;
    border-radius: 8px;
    padding: 10px;
  }
</style>
</head>
<body>

<h1>Calculatrice de Décaissement - Prototype</h1>

<div class="form-section">
  <div>
    <label>Âge actuel</label>
    <input type="number" id="age" value="65">
  </div>
  <div>
    <label>Sexe</label>
    <select id="sexe">
      <option value="H">Homme</option>
      <option value="F">Femme</option>
    </select>
  </div>
  <div>
    <label>Espérance de vie</label>
    <select id="lifeExpectancy">
      <option value="75">Courte (75 ans)</option>
      <option value="85" selected>Moyenne (85 ans)</option>
      <option value="100">Longue (100 ans)</option>
    </select>
  </div>
  <div>
    <label>Capital initial CELI ($)</label>
    <input type="number" id="celi" value="50000">
  </div>
  <div>
    <label>Capital initial REER ($)</label>
    <input type="number" id="reer" value="150000">
  </div>
  <div>
    <label>Capital initial CRI ($)</label>
    <input type="number" id="cri" value="80000">
  </div>
  <div>
    <label>Revenu désiré</label>
    <input type="number" id="revenu" value="30000">
    <select id="frequence">
      <option value="annuel">Par année</option>
      <option value="mensuel">Par mois</option>
    </select>
  </div>
  <div>
    <label>Scénario</label>
    <select id="scenario">
      <option value="1">Maximiser la durée</option>
      <option value="2">Minimiser l'impôt</option>
      <option value="3">Espérance choisie</option>
    </select>
  </div>
</div>

<canvas id="decaissChart" height="100"></canvas>

<script>
const ctx = document.getElementById('decaissChart').getContext('2d');
let chart;

// Simulation simplifiée
function simulate() {
  const age = parseInt(document.getElementById('age').value);
  const sexe = document.getElementById('sexe').value;
  const expectancy = parseInt(document.getElementById('lifeExpectancy').value);
  const celiStart = parseFloat(document.getElementById('celi').value);
  const reerStart = parseFloat(document.getElementById('reer').value);
  const criStart = parseFloat(document.getElementById('cri').value);
  const scenario = parseInt(document.getElementById('scenario').value);

  let revenu = parseFloat(document.getElementById('revenu').value);
  const frequence = document.getElementById('frequence').value;
  if (frequence === 'mensuel') revenu *= 12; // conversion en annuel

  let years = [];
  let celi = [];
  let reer = [];
  let cri = [];
  let total = [];

  // Durée de simulation
  let endAge;
  if (scenario === 3) {
    endAge = expectancy;
  } else {
    endAge = expectancy + 5;
  }

  let celiBal = celiStart;
  let reerBal = reerStart;
  let criBal = criStart;

  for (let a = age; a <= endAge; a++) {
    years.push(a);

    let withdrawCELI = 0, withdrawREER = 0, withdrawCRI = 0;
    let reste = revenu;

    // Stratégies de décaissement simplifiées
    if (scenario === 1) {
      // Maximiser durée → on prend dans CELI d'abord (pas imposable), puis REER, puis CRI
      if (celiBal >= reste) {
        withdrawCELI = reste;
      } else {
        withdrawCELI = celiBal;
        reste -= withdrawCELI;
        if (reerBal >= reste) {
          withdrawREER = reste;
        } else {
          withdrawREER = reerBal;
          reste -= withdrawREER;
          withdrawCRI = Math.min(criBal, reste);
        }
      }
    } else if (scenario === 2) {
      // Minimiser impôt → on prend dans REER le moins possible, priorité CELI et CRI
      if (celiBal >= reste) {
        withdrawCELI = reste;
      } else {
        withdrawCELI = celiBal;
        reste -= withdrawCELI;
        if (criBal >= reste) {
          withdrawCRI = reste;
        } else {
          withdrawCRI = criBal;
          reste -= withdrawCRI;
          withdrawREER = Math.min(reerBal, reste);
        }
      }
    } else if (scenario === 3) {
      // Espérance choisie → répartir le solde total sur les années restantes
      let totalBal = celiBal + reerBal + criBal;
      let yearsLeft = expectancy - a + 1;
      let retraitAnnuel = totalBal / yearsLeft;
      let retraitCible = Math.min(revenu, retraitAnnuel);

      // Proportionnel aux soldes
      let totalActuel = totalBal || 1; 
      withdrawCELI = retraitCible * (celiBal / totalActuel);
      withdrawREER = retraitCible * (reerBal / totalActuel);
      withdrawCRI = retraitCible * (criBal / totalActuel);
    }

    // Mise à jour balances
    celiBal = Math.max(0, celiBal -
