<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculatrice Retraite Optimisée</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">

  <h1>Calculatrice Retraite Optimisée</h1>

  <!-- PARAMÈTRES PERSONNELS -->
  <div class="card-grid">
    <div class="card">
      <h3>Informations personnelles</h3>
      <div class="form-group">
        <label>Âge actuel</label>
        <input type="number" id="ageActuel" value="40">
      </div>
      <div class="form-group">
        <label>Âge souhaité de la retraite</label>
        <input type="number" id="ageRetraite" value="65">
      </div>
      <div class="form-group">
        <label>Salaire actuel</label>
        <input type="number" id="salaireActuel" value="80000">
      </div>
      <div class="form-group">
        <label>Revenu désiré à la retraite</label>
        <div>
          <label><input type="radio" name="revenuChoice" value="70%"> 70%</label>
          <label><input type="radio" name="revenuChoice" value="80%"> 80%</label>
          <label><input type="radio" name="revenuChoice" value="manuel" checked> Manuel</label>
        </div>
        <input type="number" id="revenuManuel" placeholder="Entrez le montant souhaité">
      </div>
    </div>

    <!-- COMPTES -->
    <div class="card">
      <h3>Comptes et rendements</h3>
      <div class="form-group">
        <label>Rendement CELI (%)</label>
        <input type="number" id="rendCeli" value="5">
      </div>
      <div class="form-group">
        <label>Rendement REER (%)</label>
        <input type="number" id="rendReer" value="5">
      </div>
      <div class="form-group">
        <label>Rendement CRI (%)</label>
        <input type="number" id="rendCri" value="4">
      </div>
      <div class="form-group">
        <label>Rendement Non-enregistré (%)</label>
        <input type="number" id="rendNon" value="3">
      </div>
      <div class="form-group">
        <label>Cotisations annuelles additionnelles (CELI/REER/CRI/Non)</label>
        <input type="number" id="cotisationAnnuelle" value="5000">
      </div>
    </div>

    <!-- ÉVÉNEMENTS -->
    <div class="card">
      <h3>Événements financiers</h3>
      <div class="form-group">
        <label>Ajouter un événement</label>
        <input type="number" id="eventMontant" placeholder="Montant">
        <input type="number" id="eventAnnee" placeholder="Année">
        <button id="addEventBtn" class="btn-primary">Ajouter</button>
      </div>
      <div class="events-grid" id="eventsGrid"></div>
    </div>
  </div>

  <!-- SCÉNARIOS -->
  <div class="scenario-btns">
    <button class="scenario-btn active" data-scenario="duree">Max durée capital</button>
    <button class="scenario-btn" data-scenario="impot">Minimiser impôt</button>
    <button class="scenario-btn" data-scenario="esperance">Espérance de vie</button>
  </div>

  <!-- TOTAL & IMPÔT -->
  <div id="totalCapitalCard">
    <h2>Total restant: <span id="totalCapital">0</span>$</h2>
    <h3>Impôt total payé: <span id="totalImpot">0</span>$</h3>
  </div>

  <!-- GRAPHIQUE -->
  <canvas id="chartRetraite"></canvas>

  <!-- TABLEAU ANNUEL -->
  <div class="card">
    <h3>Récapitulatif annuel</h3>
    <table id="tableauAnnuel">
      <thead>
        <tr>
          <th>Année</th>
          <th>CELI</th>
          <th>REER</th>
          <th>CRI</th>
          <th>Non-enregistré</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // =============================
  // GESTION DU CHAMP REVENU MANUEL
  // =============================
  const revenuChoice = document.getElementsByName('revenuChoice');
  const revenuManuelInput = document.getElementById('revenuManuel');

  function updateRevenuManuel() {
    const selected = Array.from(revenuChoice).find(r => r.checked)?.value;
    if (selected === 'manuel') {
      revenuManuelInput.parentElement.style.display = 'flex';
    } else {
      revenuManuelInput.parentElement.style.display = 'none';
    }
  }
  revenuChoice.forEach(radio => radio.addEventListener('change', updateRevenuManuel));
  updateRevenuManuel();

  // =============================
  // ÉVÉNEMENTS
  // =============================
  const addEventBtn = document.getElementById('addEventBtn');
  const eventsGrid = document.getElementById('eventsGrid');
  let events = [];

  addEventBtn.addEventListener('click', () => {
    const montant = parseFloat(document.getElementById('eventMontant').value);
    const annee = parseInt(document.getElementById('eventAnnee').value);
    if (!isNaN(montant) && !isNaN(annee)) {
      events.push({ montant, annee });
      renderEvents();
    }
  });

  function renderEvents() {
    eventsGrid.innerHTML = '';
    events.forEach((e, i) => {
      const div = document.createElement('div');
      div.className = 'event-bubble event-add';
      div.innerHTML = `${e.annee}: ${e.montant}$ <button onclick="removeEvent(${i})">×</button>`;
      eventsGrid.appendChild(div);
    });
  }

  function removeEvent(i) {
    events.splice(i,1);
    renderEvents();
    calculerRetraite();
  }

  // =============================
  // SCÉNARIOS
  // =============================
  const scenarioBtns = document.querySelectorAll('.scenario-btn');
  let currentScenario = 'duree';
  scenarioBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      scenarioBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentScenario = btn.dataset.scenario;
      calculerRetraite();
    });
  });

  // =============================
  // CALCUL RETRAITE (simplifié exemple)
  // =============================
  const ctx = document.getElementById('chartRetraite').getContext('2d');
  let chart;

  function calculerRetraite() {
    const ageActuel = parseInt(document.getElementById('ageActuel').value);
    const ageRetraite = parseInt(document.getElementById('ageRetraite').value);
    const salaireActuel = parseFloat(document.getElementById('salaireActuel').value);
    const selected = Array.from(revenuChoice).find(r => r.checked)?.value;
    const revenuDesire = selected === 'manuel' ? parseFloat(revenuManuelInput.value) : 
                         (selected === '70%' ? salaireActuel*0.7 : salaireActuel*0.8);

    const rendCeli = parseFloat(document.getElementById('rendCeli').value)/100;
    const rendReer = parseFloat(document.getElementById('rendReer').value)/100;
    const rendCri = parseFloat(document.getElementById('rendCri').value)/100;
    const rendNon = parseFloat(document.getElementById('rendNon').value)/100;
    const cotisationAnnuelle = parseFloat(document.getElementById('cotisationAnnuelle').value);

    const nbAnnees = 100 - ageActuel;
    let celi = 100000, reer = 150000, cri = 80000, non = 20000;
    let totalImpots = 0;
    let labels = [];
    let dataCeli = [], dataReer = [], dataCri = [], dataNon = [], dataTotal = [];
    let tbody = '';

    for(let i=0;i<nbAnnees;i++){
      const annee = ageActuel + i;
      // Cotisations supplémentaires jusqu'à la retraite
      if(annee < ageRetraite){
        celi += cotisationAnnuelle*0.25;
        reer += cotisationAnnuelle*0.5;
        cri += cotisationAnnuelle*0.25;
      }

      // Rendements
      celi *= (1+rendCeli);
      reer *= (1+rendReer);
      cri *= (1+rendCri);
      non *= (1+rendNon);

      // Retraits après retraite
      if(annee>=ageRetraite){
        const retrait = revenuDesire;
        let impot = retrait*0.2; // exemple simplifié
        totalImpots += impot;
        // retirer d'abord non-enregistré, puis CRI, REER, CELI (simplifié)
        let restant = retrait;
        if(non>=restant){ non-=restant; } else { restant-=non; non=0; }
        if(cri>=restant){ cri-=restant; } else { restant-=cri; cri=0; }
        if(reer>=restant){ reer-=restant; } else { restant-=reer; reer=0; }
        if(celi>=restant){ celi-=restant; } else { celi=0; }
      }

      // Ajouter événements
      events.filter(e=>e.annee===annee).forEach(e=>{
        non += e.montant;
      });

      labels.push(annee);
      dataCeli.push(Math.max(celi,0));
      dataReer.push(Math.max(reer,0));
      dataCri.push(Math.max(cri,0));
      dataNon.push(Math.max(non,0));
      dataTotal.push(celi+reer+cri+non);

      tbody += `<tr>
        <td>${annee}</td>
        <td>${Math.round(celi)}</td>
        <td>${Math.round(reer)}</td>
        <td>${Math.round(cri)}</td>
        <td>${Math.round(non)}</td>
        <td>${Math.round(celi+reer+cri+non)}</td>
      </tr>`;
    }

    document.getElementById('totalCapital').textContent = Math.round(celi+reer+cri+non);
    document.getElementById('totalImpot').textContent = Math.round(totalImpots);

    document.querySelector('#tableauAnnuel tbody').innerHTML = tbody;

    if(chart){ chart.destroy(); }
    chart = new Chart(ctx, {
      type:'line',
      data:{
        labels: labels,
        datasets:[
          {label:'CELI', data:dataCeli, backgroundColor:'rgba(0,196,140,0.4)', borderColor:'rgba(0,196,140,0.8)', fill:true},
          {label:'REER', data:dataReer, backgroundColor:'rgba(26,115,232,0.4)', borderColor:'rgba(26,115,232,0.8)', fill:true},
          {label:'CRI', data:dataCri, backgroundColor:'rgba(255,193,7,0.4)', borderColor:'rgba(255,193,7,0.8)', fill:true},
          {label:'Non-enregistré', data:dataNon, backgroundColor:'rgba(220,53,69,0.4)', borderColor:'rgba(220,53,69,0.8)', fill:true},
          {label:'Total', data:dataTotal, type:'line', borderColor:'#1a1a1a', fill:false, borderWidth:2}
        ]
      },
      options:{
        responsive:true,
        plugins:{legend:{position:'top'}},
        scales:{y:{beginAtZero:true}}
      }
    });
  }

  // Initial
  calculerRetraite();
</script>
</body>
</html>
