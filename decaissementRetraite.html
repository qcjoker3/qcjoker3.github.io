<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificateur de Décaissement Retraite - Finoza</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <style>
    /* ================= STYLES CSS ================= */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Lora:wght@600&display=swap');

    :root {
        --primary-color: #0D9488;
        --primary-gradient: linear-gradient(90deg, #0D9488, #0F766E);
        --bg-color: #F9FAFB;
        --card-bg-color: #FFFFFF;
        --text-color: #374151;
        --heading-color: #111827;
        --border-color: #E5E7EB;
        --light-text: #FFFFFF;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --bg-color: #111827;
            --card-bg-color: #1F2937;
            --text-color: #9CA3AF;
            --heading-color: #F9FAFB;
            --border-color: #374151;
        }
    }

    body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.6; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    header { background: var(--card-bg-color); padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: center; margin-bottom: 2rem; }
    header h1 { font-family: 'Lora', serif; color: var(--heading-color); margin: 0; font-size: 2rem; }
    
    /* Cards & Grid */
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .card { background: var(--card-bg-color); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
    h3 { font-family: 'Lora', serif; color: var(--heading-color); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }

    /* Form Elements */
    .form-group { margin-bottom: 1rem; }
    label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--heading-color); }
    input, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-color); color: var(--text-color); font-size: 1rem; box-sizing: border-box; }
    input:focus, select:focus { outline: 2px solid var(--primary-color); border-color: transparent; }

    /* Buttons */
    .btn-primary { background: var(--primary-gradient); color: var(--light-text); border: none; padding: 0.75rem 1.5rem; border-radius: 50px; cursor: pointer; font-weight: 600; transition: transform 0.2s; width: 100%; margin-top: 0.5rem; }
    .btn-primary:hover { transform: scale(1.02); }
    .scenario-btn { width: auto; flex: 1; min-width: 120px; font-size: 0.9rem; }

    /* Results */
    .results-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .result-box { background: var(--bg-color); padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
    .result-label { font-size: 0.85rem; display: block; margin-bottom: 5px; }
    .result-value { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); font-family: 'Lora', serif; }
    
    /* Table */
    .table-wrapper { overflow-x: auto; max-height: 500px; border: 1px solid var(--border-color); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th { position: sticky; top: 0; background: var(--bg-color); z-index: 10; text-align: right; padding: 10px; border-bottom: 2px solid var(--border-color); font-weight: 600; }
    td { padding: 8px 10px; border-bottom: 1px solid var(--border-color); text-align: right; }
    tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }

    .helper { font-size: 0.8rem; color: var(--text-color); opacity: 0.8; margin-top: 4px; }
    .chart-container { position: relative; height: 400px; width: 100%; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<header>
    <h1>Planificateur de Décaissement Retraite</h1>
</header>

<div class="container">
    
    <div class="card-grid">
      
      <div class="card">
        <h3>Profil & Objectifs</h3>
        <div class="form-group"><label>Âge actuel</label><input type="number" id="ageActuel" value="40" /></div>
        <div class="form-group"><label>Âge de retraite</label><input type="number" id="ageRetraite" value="65" /></div>
        <div class="form-group"><label>Salaire actuel ($/an)</label><input type="number" id="salaireActuel" value="80000" /></div>
        <div class="form-group"><label>Inflation estimée (%)</label><input type="number" id="inflation" value="2.5" step="0.1" /></div>
        <div class="form-group">
          <label>Espérance de vie</label>
          <select id="esperanceVie">
            <option value="90">90 ans</option>
            <option value="95" selected>95 ans</option>
            <option value="100">100 ans</option>
          </select>
        </div>
        <div class="form-group">
            <label>Revenu cible (Retraite)</label>
            <select id="revenuChoix">
                <option value="70" selected>70% du salaire (indexé)</option>
                <option value="manuel">Montant fixe (valeur d'aujourd'hui)</option>
            </select>
        </div>
        <div id="revenuManuelGroup" class="form-group" style="display:none">
            <input type="number" id="revenuManuel" placeholder="Ex: 50000" />
        </div>
      </div>

      <div class="card">
        <h3>Épargne Actuelle</h3>
        <div class="form-group"><label>CELI ($)</label><input type="number" id="celiActuel" value="50000" /></div>
        <div class="form-group"><label>REER ($)</label><input type="number" id="reerActuel" value="120000" /></div>
        <div class="form-group"><label>CRI ($)</label><input type="number" id="criActuel" value="60000" /></div>
        <div class="form-group"><label>Non-enregistré ($)</label><input type="number" id="nonActuel" value="40000" /></div>
      </div>

      <div class="card">
        <h3>Ajouts Annuels (jusqu'à la retraite)</h3>
        <div class="form-group"><label>Cotisation CELI</label><input type="number" id="celiCot" value="7000" /></div>
        <div class="form-group"><label>Cotisation REER</label><input type="number" id="reerCot" value="10000" /></div>
        <div class="form-group"><label>Cotisation CRI</label><input type="number" id="criCot" value="0" disabled style="opacity:0.5" /><p class="helper">Rarement possible d'ajouter au CRI</p></div>
        <div class="form-group"><label>Cotisation Non-enreg.</label><input type="number" id="nonCot" value="5000" /></div>
      </div>

      <div class="card">
        <h3>Rendements & Rentes Publiques</h3>
        <div class="form-group"><label>Rend. REER/CRI (%)</label><input type="number" id="reerRend" value="6.0" step="0.1" /></div>
        <div class="form-group"><label>Rend. CELI (%)</label><input type="number" id="celiRend" value="5.5" step="0.1" /></div>
        <div class="form-group"><label>Rend. Non-enreg. (%)</label><input type="number" id="nonRend" value="5.0" step="0.1" /></div>
        <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 15px 0;">
        <div class="form-group"><label>RRQ à 65 ans (valeur d'auj.)</label><input type="number" id="rrq65" value="1300" /></div>
        <div class="form-group"><label>PSV à 65 ans (valeur d'auj.)</label><input type="number" id="psv65" value="713" /></div>
        <div class="form-group"><label>Âge début RRQ</label><input type="number" id="ageRRQ" value="65" /></div>
        <div class="form-group"><label>Âge début PSV</label><input type="number" id="agePSV" value="65" /></div>
      </div>

      <div class="card">
        <h3>Pension & Projets</h3>
        <div class="form-group">
            <label>Fonds de pension employeur?</label>
            <select id="pensionChoix">
                <option value="non">Non</option>
                <option value="oui">Oui</option>
            </select>
        </div>
        <div id="fondPensionGroup" style="display:none">
            <div class="form-group"><label>Rente annuelle (valeur auj.)</label><input type="number" id="rentePension" value="20000" /></div>
            <div class="form-group"><label>Indexation (%)</label><input type="number" id="indexPension" value="1.0" step="0.1" /></div>
            <div class="form-group"><label>Âge début</label><input type="number" id="agePension" value="65" /></div>
        </div>
        <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 15px 0;">
        <label>Événements ponctuels (ex: achat auto)</label>
        <div id="evenementsContainer"></div>
        <button id="ajoutEvenement" class="btn-primary" style="font-size:0.9rem; margin-top:5px;">+ Ajouter un événement</button>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <h3 style="text-align:center; border:none;">Lancer la Simulation</h3>
        <p style="text-align:center; margin-bottom:1rem;">Le système testera toutes les combinaisons de décaissement pour trouver l'optimale selon votre choix.</p>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <button class="btn-primary scenario-btn" data-s="duree">Max Durée</button>
            <button class="btn-primary scenario-btn" data-s="impot">Min Impôt</button>
            <button class="btn-primary scenario-btn" data-s="capitalFinal">Max Héritage</button>
        </div>
      </div>
    </div>

    <div id="resultsArea" style="display:none; margin-top: 2rem; animation: fadeIn 0.5s ease-out;">
        
        <div class="card">
            <h3>Résultats de la Stratégie Optimale</h3>
            <div class="results-dashboard">
                <div class="result-box">
                    <span class="result-label">Capital Final (à <span id="lblFin"></span> ans)</span>
                    <span class="result-value" id="resCapitalFinal">$0</span>
                </div>
                <div class="result-box">
                    <span class="result-label">Âge d'épuisement</span>
                    <span class="result-value" id="resAgeEpuisement">Jamais</span>
                </div>
                <div class="result-box">
                    <span class="result-label">Impôt Total Payé</span>
                    <span class="result-value" id="resImpotTotal">$0</span>
                </div>
                <div class="result-box">
                    <span class="result-label">Ordre de Décaissement</span>
                    <span class="result-value" id="resOrdre" style="font-size:1.1rem;"></span>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:1.5rem;">
            <h3>Évolution des Actifs</h3>
            <div class="chart-container">
                <canvas id="graphiqueSoldes"></canvas>
            </div>
        </div>

        <div class="card" style="margin-top:1.5rem;">
            <h3>Détail Année par Année</h3>
            <div class="table-wrapper">
                <table id="tableauAnnuel">
                    <thead>
                        <tr>
                            <th>Âge</th>
                            <th>Dépense Cible (Indexée)</th>
                            <th>Revenu Fixe</th>
                            <th>Retrait Épargne</th>
                            <th>Impôt Estimé</th>
                            <th>Solde CELI</th>
                            <th>Solde REER</th>
                            <th>Solde CRI</th>
                            <th>Solde Non-Enr</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    
    // --- 1. GESTION DE L'INTERFACE ---
    
    // Affichage des champs conditionnels
    document.getElementById("revenuChoix").addEventListener("change", (e) => {
        document.getElementById("revenuManuelGroup").style.display = e.target.value === "manuel" ? "block" : "none";
    });

    document.getElementById("pensionChoix").addEventListener("change", (e) => {
        document.getElementById("fondPensionGroup").style.display = e.target.value === "oui" ? "block" : "none";
    });

    // Gestion des événements ponctuels
    const evtContainer = document.getElementById("evenementsContainer");
    document.getElementById("ajoutEvenement").addEventListener("click", () => {
        if (evtContainer.children.length >= 5) return;
        const div = document.createElement("div");
        div.style.cssText = "display:flex; gap:5px; margin-bottom:5px;";
        div.innerHTML = `
            <input type="number" class="evtAge" placeholder="Âge" style="width:70px">
            <input type="number" class="evtMontant" placeholder="Montant ($ auj.)" style="flex:1">
            <button type="button" onclick="this.parentElement.remove()" style="background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer;">X</button>
        `;
        evtContainer.appendChild(div);
    });

    // --- 2. CONSTANTES FISCALES & MATHÉMATIQUES ---
    
    // Facteurs de retrait minimum FERR (simplifiés)
    const facteursFERR = { 71:0.0528, 72:0.0540, 73:0.0553, 74:0.0567, 75:0.0582, 80:0.0682, 85:0.0851, 90:0.1192, 95:0.2000 };
    function getFerrFactor(age) {
        if (age < 71) return 0;
        if (age >= 95) return 0.20;
        // Interpolation simple pour les âges manquants
        return facteursFERR[age] || (1 / (90 - age)); 
    }

    // Paliers d'imposition 2024 (Fédéral + Québec combinés approximatifs pour simulation)
    const tablesImpot = [
        [50000, 0.27],   
        [100000, 0.37],  
        [150000, 0.41],
        [Infinity, 0.50] 
    ];

    // --- 3. MOTEUR DE CALCUL ---

    function calculerImpot(revenu, inflationCumulee) {
        let impot = 0;
        let revenuRestant = revenu;
        let dernierSeuil = 0;

        for (let [seuilBase, taux] of tablesImpot) {
            let seuilIndexe = seuilBase * inflationCumulee;
            let tranche = Math.min(revenuRestant, seuilIndexe - dernierSeuil);
            
            if (tranche > 0) {
                impot += tranche * taux;
                revenuRestant -= tranche;
                dernierSeuil = seuilIndexe;
            } else {
                break;
            }
        }
        return impot;
    }

    function permuter(arr) {
        if (arr.length <= 1) return [arr];
        return arr.flatMap((v, i) => permuter([...arr.slice(0, i), ...arr.slice(i + 1)]).map(p => [v, ...p]));
    }

    function lancerSimulation(strategie) {
        const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
        
        const ageActuel = getVal("ageActuel");
        const ageRetraite = getVal("ageRetraite");
        const esperanceVie = parseInt(document.getElementById("esperanceVie").value);
        const inflation = getVal("inflation") / 100;
        const salaire = getVal("salaireActuel");

        // Actifs & Cotisations
        const actifs = {
            celi: { solde: getVal("celiActuel"), cot: getVal("celiCot"), rend: getVal("celiRend")/100 },
            reer: { solde: getVal("reerActuel"), cot: getVal("reerCot"), rend: getVal("reerRend")/100 },
            cri: { solde: getVal("criActuel"), cot: 0, rend: getVal("reerRend")/100 },
            nonEnr: { solde: getVal("nonActuel"), cot: getVal("nonCot"), rend: getVal("nonRend")/100 }
        };

        // Rentes
        const rrq = { montant: getVal("rrq65"), debut: getVal("ageRRQ") };
        const psv = { montant: getVal("psv65"), debut: getVal("agePSV") };
        const pension = { 
            active: document.getElementById("pensionChoix").value === "oui",
            montant: getVal("rentePension"),
            index: getVal("indexPension")/100,
            debut: getVal("agePension")
        };

        // Cible
        let revenuCibleBase = 0;
        if (document.getElementById("revenuChoix").value === "manuel") {
            revenuCibleBase = getVal("revenuManuel");
        } else {
            revenuCibleBase = salaire * (parseFloat(document.getElementById("revenuChoix").value) / 100);
        }

        // Événements
        const events = Array.from(document.querySelectorAll("#evenementsContainer div")).map(div => ({
            age: parseFloat(div.querySelector(".evtAge").value),
            montant: parseFloat(div.querySelector(".evtMontant").value)
        })).filter(e => e.age && e.montant);

        // --- BOUCLE D'OPTIMISATION ---
        const ordres = permuter(['nonEnr', 'celi', 'reer', 'cri']);
        let meilleurResultat = null;

        ordres.forEach(ordre => {
            let soldes = { 
                celi: actifs.celi.solde, 
                reer: actifs.reer.solde, 
                cri: actifs.cri.solde, 
                nonEnr: actifs.nonEnr.solde 
            };

            let historique = [];
            let impotTotalCumule = 0;
            let capitalFinal = 0;
            let aEpuise = false;
            let ageEpuisement = null;

            for (let age = ageActuel; age <= esperanceVie; age++) {
                let facteurInflation = Math.pow(1 + inflation, age - ageActuel);

                // Phase Accumulation
                if (age < ageRetraite) {
                    soldes.celi = (soldes.celi + actifs.celi.cot) * (1 + actifs.celi.rend);
                    soldes.reer = (soldes.reer + actifs.reer.cot) * (1 + actifs.reer.rend);
                    soldes.cri = (soldes.cri) * (1 + actifs.cri.rend);
                    soldes.nonEnr = (soldes.nonEnr + actifs.nonEnr.cot) * (1 + actifs.nonEnr.rend);
                    
                    historique.push({ age, type: 'accumulation', soldes: {...soldes} });
                    continue;
                }

                // Phase Décaissement
                
                // --- CORRECTION DE L'INFLATION DES RENTES ---
                let rrqAnnuel = 0;
                if (age >= rrq.debut) {
                    let ajustement = 1 + (rrq.debut - 65) * 12 * (rrq.debut < 65 ? -0.006 : 0.007);
                    // On indexe le montant de base (valeur d'aujourd'hui) jusqu'à l'année courante de la simulation
                    rrqAnnuel = (rrq.montant * 12) * ajustement * facteurInflation;
                }

                let psvAnnuel = 0;
                if (age >= psv.debut) {
                    let ajustement = 1 + Math.max(0, Math.min(70, psv.debut) - 65) * 12 * 0.006;
                    // On indexe le montant de base jusqu'à l'année courante
                    psvAnnuel = (psv.montant * 12) * ajustement * facteurInflation;
                    if (age >= 75) psvAnnuel *= 1.10;
                }

                let pensionAnnuelle = 0;
                if (pension.active && age >= pension.debut) {
                    // Indexation spécifique pour la pension privée
                    // 1. On amène la rente à sa valeur au début de la retraite (inflation générale)
                    let valDebut = pension.montant * Math.pow(1 + inflation, pension.debut - ageActuel);
                    // 2. On applique son propre taux d'indexation à partir de là
                    pensionAnnuelle = valDebut * Math.pow(1 + pension.index, age - pension.debut);
                }

                let revenuFixeTotal = rrqAnnuel + psvAnnuel + pensionAnnuelle;

                // Besoin Net Cible
                let depenseCible = revenuCibleBase * facteurInflation;
                
                // --- CORRECTION ÉVÉNEMENTS ---
                let evt = events.find(e => e.age === age);
                if (evt) {
                    // L'événement est aussi indexé à l'inflation
                    depenseCible += (evt.montant * facteurInflation);
                }

                let manqueAGagnerNet = Math.max(0, depenseCible - revenuFixeTotal);
                
                let retraitCeli = 0, retraitReer = 0, retraitCri = 0, retraitNonEnr = 0;

                // Retraits minimums (FERR/FRV)
                let minReer = soldes.reer * getFerrFactor(age);
                let minCri = soldes.cri * getFerrFactor(age);
                
                retraitReer = minReer;
                retraitCri = minCri;
                
                // Impôt de base (sur rentes + minima)
                let revenuImposableBase = rrqAnnuel + psvAnnuel + pensionAnnuelle + minReer + minCri;
                let impotBase = calculerImpot(revenuImposableBase, facteurInflation);
                
                let netDispo = revenuFixeTotal + minReer + minCri - impotBase;
                let besoinRestant = Math.max(0, depenseCible - netDispo);

                const tauxMarginalEstime = 0.35; 

                ordre.forEach(compte => {
                    if (besoinRestant <= 1) return;

                    if (compte === 'celi') {
                        let aPrendre = Math.min(soldes.celi, besoinRestant);
                        retraitCeli += aPrendre;
                        besoinRestant -= aPrendre;
                    } 
                    else if (compte === 'nonEnr') {
                        let aPrendre = Math.min(soldes.nonEnr, besoinRestant);
                        retraitNonEnr += aPrendre;
                        besoinRestant -= aPrendre;
                    }
                    else if (compte === 'reer') {
                        let besoinBrut = besoinRestant / (1 - tauxMarginalEstime);
                        let disponibleSup = Math.max(0, soldes.reer - retraitReer);
                        let aPrendre = Math.min(disponibleSup, besoinBrut);
                        retraitReer += aPrendre;
                        besoinRestant -= (aPrendre * (1 - tauxMarginalEstime));
                    }
                    else if (compte === 'cri') {
                         let besoinBrut = besoinRestant / (1 - tauxMarginalEstime);
                         let disponibleSup = Math.max(0, soldes.cri - retraitCri);
                         let aPrendre = Math.min(disponibleSup, besoinBrut);
                         retraitCri += aPrendre;
                         besoinRestant -= (aPrendre * (1 - tauxMarginalEstime));
                    }
                });

                soldes.celi -= retraitCeli;
                soldes.nonEnr -= retraitNonEnr;
                soldes.reer -= retraitReer;
                soldes.cri -= retraitCri;

                let revenuImposableTotal = rrqAnnuel + psvAnnuel + pensionAnnuelle + retraitReer + retraitCri;
                let impotFinal = calculerImpot(revenuImposableTotal, facteurInflation);
                
                impotTotalCumule += impotFinal;

                if (!aEpuise && (soldes.celi + soldes.reer + soldes.cri + soldes.nonEnr) < 100) {
                    aEpuise = true;
                    ageEpuisement = age;
                }

                soldes.celi *= (1 + actifs.celi.rend);
                soldes.reer *= (1 + actifs.reer.rend);
                soldes.cri *= (1 + actifs.cri.rend);
                soldes.nonEnr *= (1 + actifs.nonEnr.rend);

                historique.push({
                    age,
                    type: 'decaiss',
                    depenseCible,
                    revenuFixe: revenuFixeTotal,
                    retraitTotal: retraitCeli + retraitReer + retraitCri + retraitNonEnr,
                    impot: impotFinal,
                    soldes: {...soldes},
                    details: { celi: retraitCeli, reer: retraitReer, cri: retraitCri, non: retraitNonEnr }
                });
            }

            capitalFinal = soldes.celi + soldes.reer + soldes.cri + soldes.nonEnr;
            if (!ageEpuisement) ageEpuisement = esperanceVie + 1;

            let score = 0;
            if (strategie === 'duree') score = ageEpuisement * 10000000 + capitalFinal;
            else if (strategie === 'impot') score = -impotTotalCumule;
            else if (strategie === 'capitalFinal') score = capitalFinal;

            if (!meilleurResultat || score > meilleurResultat.score) {
                meilleurResultat = {
                    score,
                    ordre,
                    capitalFinal,
                    ageEpuisement,
                    impotTotalCumule,
                    historique
                };
            }
        });

        afficherResultats(meilleurResultat, esperanceVie);
    }

    function afficherResultats(res, esperanceVie) {
        document.getElementById("resultsArea").style.display = "block";
        
        const fmt = (v) => v.toLocaleString('fr-CA', {style:'currency', currency:'CAD', maximumFractionDigits:0});

        document.getElementById("lblFin").innerText = esperanceVie;
        document.getElementById("resCapitalFinal").innerText = fmt(res.capitalFinal);
        document.getElementById("resAgeEpuisement").innerText = res.ageEpuisement > esperanceVie ? "Jamais" : res.ageEpuisement + " ans";
        document.getElementById("resImpotTotal").innerText = fmt(res.impotTotalCumule);
        
        const nomsComptes = { 'nonEnr': 'Non-Enreg', 'celi': 'CELI', 'reer': 'REER', 'cri': 'CRI' };
        document.getElementById("resOrdre").innerText = res.ordre.map(c => nomsComptes[c]).join(" ➤ ");

        const tbody = document.querySelector("#tableauAnnuel tbody");
        tbody.innerHTML = "";
        
        res.historique.filter(h => h.type === 'decaiss').forEach(h => {
            let tr = document.createElement("tr");
            tr.innerHTML = `
                <td><strong>${h.age}</strong></td>
                <td>${fmt(h.depenseCible)}</td>
                <td>${fmt(h.revenuFixe)}</td>
                <td>${fmt(h.retraitTotal)}</td>
                <td style="color:#ef4444">${fmt(h.impot)}</td>
                <td>${fmt(h.soldes.celi)}</td>
                <td>${fmt(h.soldes.reer)}</td>
                <td>${fmt(h.soldes.cri)}</td>
                <td>${fmt(h.soldes.nonEnr)}</td>
            `;
            tbody.appendChild(tr);
        });

        dessinerGraphique(res.historique);
        document.getElementById("resultsArea").scrollIntoView({behavior: 'smooth'});
    }

    let myChart = null;
    function dessinerGraphique(historique) {
        const ctx = document.getElementById('graphiqueSoldes').getContext('2d');
        if (myChart) myChart.destroy();

        const labels = historique.map(h => h.age);
        const dataCeli = historique.map(h => h.soldes.celi);
        const dataReer = historique.map(h => h.soldes.reer);
        const dataCri = historique.map(h => h.soldes.cri);
        const dataNon = historique.map(h => h.soldes.nonEnr);

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'CELI', data: dataCeli, borderColor: '#10B981', backgroundColor: '#10B981', fill: false },
                    { label: 'REER', data: dataReer, borderColor: '#F59E0B', backgroundColor: '#F59E0B', fill: false },
                    { label: 'CRI', data: dataCri, borderColor: '#EF4444', backgroundColor: '#EF4444', fill: false },
                    { label: 'Non-Enreg', data: dataNon, borderColor: '#3B82F6', backgroundColor: '#3B82F6', fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { callback: (v) => v/1000 + 'k$' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + Math.round(context.raw).toLocaleString() + ' $';
                            }
                        }
                    }
                }
            }
        });
    }

    document.querySelectorAll(".scenario-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const strategie = btn.dataset.s;
            lancerSimulation(strategie);
        });
    });
});
</script>

</body>
</html>
