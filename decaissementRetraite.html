<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calculatrice Retraite</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Calculatrice Retraite Optimisée</h1>
  </header>

  <div class="container">

    <!-- SECTION REVENUS -->
    <div class="card-grid">
      <div class="card">
        <h3>Informations personnelles</h3>
        <div class="form-group">
          <label>Salaire annuel actuel ($)</label>
          <input type="number" id="currentSalary" value="80000">
        </div>
        <div class="form-group">
          <label>Revenu désiré à la retraite</label>
          <select id="incomeChoice">
            <option value="0.7">70% du revenu actuel</option>
            <option value="0.8">80% du revenu actuel</option>
            <option value="manual">Manuel</option>
          </select>
        </div>
        <div class="form-group" id="manualIncomeDiv" style="display:none;">
          <label>Revenu manuel ($)</label>
          <input type="number" id="manualIncome" value="56000">
        </div>
      </div>

      <!-- COMPTES -->
      <div class="card">
        <h3>Comptes</h3>
        <div class="form-group">
          <label>CELI ($)</label>
          <input type="number" id="celi" value="20000">
        </div>
        <div class="form-group">
          <label>REER ($)</label>
          <input type="number" id="reer" value="50000">
        </div>
        <div class="form-group">
          <label>CRI ($)</label>
          <input type="number" id="cri" value="0">
        </div>
        <div class="form-group">
          <label>Non Enregistré ($)</label>
          <input type="number" id="nonReg" value="10000">
        </div>
        <div class="form-group">
          <label>Rendement annuel (%)</label>
          <input type="number" id="returnRate" value="5">
        </div>
        <div class="form-group">
          <label>Cotisation annuelle CELI ($)</label>
          <input type="number" id="annualCeli" value="6000">
        </div>
        <div class="form-group">
          <label>Cotisation annuelle REER ($)</label>
          <input type="number" id="annualReer" value="5000">
        </div>
        <div class="form-group">
          <label>Cotisation annuelle CRI ($)</label>
          <input type="number" id="annualCri" value="0">
        </div>
        <div class="form-group">
          <label>Cotisation annuelle Non Enregistré ($)</label>
          <input type="number" id="annualNonReg" value="2000">
        </div>
      </div>
    </div>

    <!-- Événements financiers -->
    <div class="card">
      <h3>Événements financiers</h3>
      <div id="eventsContainer"></div>
      <button class="btn-primary" onclick="addEvent()">Ajouter un événement</button>
    </div>

    <!-- Scénarios -->
    <div class="card scenario-card">
      <h3>Scénarios</h3>
      <button class="scenario-btn active" onclick="setScenario('maxDuration')">Max Durée Capital</button>
      <button class="scenario-btn" onclick="setScenario('minTax')">Min Impôt</button>
      <button class="scenario-btn" onclick="setScenario('lifeExpectancy')">Espérance Vie</button>
      <div class="form-group" style="margin-top:10px;">
        <label>Espérance vie pour scénario 3</label>
        <select id="lifeExpSelect">
          <option value="70">Courte (70 ans)</option>
          <option value="85" selected>Moyenne (85 ans)</option>
          <option value="100">Longue (100 ans)</option>
        </select>
      </div>
    </div>

    <!-- Total -->
    <div id="totalCapitalCard">
      <h2>Total Capital : $<span id="totalCapital">0</span></h2>
      <h3>Total Impôt : $<span id="totalTax">0</span></h3>
    </div>

    <!-- Graphique -->
    <canvas id="capitalChart" height="400"></canvas>

    <!-- Tableau annuel -->
    <div class="card">
      <h3>Tableau Annuel</h3>
      <table id="annualTable">
        <thead>
          <tr>
            <th>Année</th>
            <th>CELI</th>
            <th>REER</th>
            <th>CRI</th>
            <th>Non Enregistré</th>
            <th>Total</th>
            <th>Retraits cumulés</th>
            <th>Impôt cumulés</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button class="btn-primary" onclick="calculate()">Calculer</button>

  </div>

  <script>
    // Gestion champ manuel revenu
    const incomeChoice = document.getElementById('incomeChoice');
    const manualDiv = document.getElementById('manualIncomeDiv');
    incomeChoice.addEventListener('change', () => {
      manualDiv.style.display = incomeChoice.value === 'manual' ? 'block' : 'none';
    });

    // Événements financiers dynamiques
    let events = [];
    function addEvent() {
      const container = document.getElementById('eventsContainer');
      const idx = events.length;
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = `
        <label>Événement ${idx+1} :</label>
        <select class="eventType">
          <option value="add">Ajout</option>
          <option value="withdraw">Retrait</option>
        </select>
        <input type="number" class="eventAmount" placeholder="Montant ($)">
        <input type="number" class="eventYear" placeholder="Année">
      `;
      container.appendChild(div);
      events.push({type:'add', amount:0, year:2025});
    }

    // Scénario actif
    let activeScenario = 'maxDuration';
    function setScenario(scenario){
      activeScenario = scenario;
      document.querySelectorAll('.scenario-btn').forEach(btn=>btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // Calculs
    function calculate() {
      // Récupérer valeurs
      const salary = parseFloat(document.getElementById('currentSalary').value);
      let desiredIncome;
      if(incomeChoice.value==='manual') desiredIncome = parseFloat(document.getElementById('manualIncome').value);
      else desiredIncome = salary * parseFloat(incomeChoice.value);

      let celi = parseFloat(document.getElementById('celi').value);
      let reer = parseFloat(document.getElementById('reer').value);
      let cri = parseFloat(document.getElementById('cri').value);
      let nonReg = parseFloat(document.getElementById('nonReg').value);

      const returnRate = parseFloat(document.getElementById('returnRate').value)/100;

      const annualCeli = parseFloat(document.getElementById('annualCeli').value);
      const annualReer = parseFloat(document.getElementById('annualReer').value);
      const annualCri = parseFloat(document.getElementById('annualCri').value);
      const annualNonReg = parseFloat(document.getElementById('annualNonReg').value);

      // Événements
      const eventElems = document.querySelectorAll('#eventsContainer .form-group');
      let parsedEvents = [];
      eventElems.forEach(el=>{
        const type = el.querySelector('.eventType').value;
        const amount = parseFloat(el.querySelector('.eventAmount').value) || 0;
        const year = parseInt(el.querySelector('.eventYear').value) || 2025;
        parsedEvents.push({type, amount, year});
      });

      // Simuler années
      const startYear = 2025;
      const endYear = 100; // limite arbitraire pour éviter overflow
      let annualData = [];
      let totalWithdrawn = 0;
      let totalTax = 0;

      let tempCeli = celi;
      let tempReer = reer;
      let tempCri = cri;
      let tempNonReg = nonReg;

      for(let year=startYear; year<startYear+endYear; year++){
        // Appliquer rendement
        tempCeli *= 1+returnRate;
        tempReer *= 1+returnRate;
        tempCri *= 1+returnRate;
        tempNonReg *= 1+returnRate;

        // Ajouter cotisations annuelles
        tempCeli += annualCeli;
        tempReer += annualReer;
        tempCri += annualCri;
        tempNonReg += annualNonReg;

        // Appliquer événements financiers
        parsedEvents.filter(e=>e.year===year).forEach(e=>{
          if(e.type==='add'){
            // Répartir ajout dans les comptes automatiquement (CELI->REER->CRI->NonReg)
            let remaining = e.amount;
            remaining -= Math.min(6000-tempCeli, remaining); tempCeli += Math.min(6000-tempCeli, remaining);
            remaining -= Math.min(18000-tempReer, remaining); tempReer += Math.min(18000-tempReer, remaining);
            remaining -= Math.min(18000-tempCri, remaining); tempCri += Math.min(18000-tempCri, remaining);
            tempNonReg += remaining;
          } else {
            // Retrait automatique (NonReg->CELI->REER->CRI)
            let remaining = e.amount;
            let withdrawn = 0;
            let tax = 0;
            if(tempNonReg>=remaining){tempNonReg-=remaining; withdrawn=remaining; tax+=remaining*0.25; remaining=0;}
            else{remaining-=tempNonReg; withdrawn+=tempNonReg; tax+=tempNonReg*0.25; tempNonReg=0;}
            if(remaining>0 && tempCeli>=remaining){tempCeli-=remaining; withdrawn+=remaining; remaining=0;}
            else if(remaining>0){remaining-=tempCeli; withdrawn+=tempCeli; tempCeli=0;}
            if(remaining>0 && tempReer>=remaining){tempReer-=remaining; withdrawn+=remaining; tax+=remaining*0.25; remaining=0;}
            else if(remaining>0){remaining-=tempReer; withdrawn+=tempReer; tempReer=0;}
            if(remaining>0 && tempCri>=remaining){tempCri-=remaining; withdrawn+=remaining; tax+=remaining*0.25; remaining=0;}
            totalWithdrawn += withdrawn;
            totalTax += tax;
          }
        });

        let total = tempCeli + tempReer + tempCri + tempNonReg;
        annualData.push({year, celi:tempCeli, reer:tempReer, cri:tempCri, nonReg:tempNonReg, total, withdrawn: totalWithdrawn, tax: totalTax});

        // Stop si tous les comptes = 0
        if(tempCeli+tempReer+tempCri+tempNonReg<=0) break;
      }

      document.getElementById('totalCapital').innerText = Math.round(tempCeli+tempReer+tempCri+tempNonReg);
      document.getElementById('totalTax').innerText = Math.round(totalTax);

      // Tableau annuel
      const tbody = document.querySelector('#annualTable tbody');
      tbody.innerHTML='';
      annualData.forEach(d=>{
        const row = `<tr>
          <td>${d.year}</td>
          <td>${Math.round(d.celi)}</td>
          <td>${Math.round(d.reer)}</td>
          <td>${Math.round(d.cri)}</td>
          <td>${Math.round(d.nonReg)}</td>
          <td>${Math.round(d.total)}</td>
          <td>${Math.round(d.withdrawn)}</td>
          <td>${Math.round(d.tax)}</td>
        </tr>`;
        tbody.innerHTML += row;
      });

      // Graphique Chart.js
      if(window.capitalChartInstance) window.capitalChartInstance.destroy();
      const ctx = document.getElementById('capitalChart').getContext('2d');
      window.capitalChartInstance = new Chart(ctx, {
        type:'line',
        data:{
          labels: annualData.map(d=>d.year),
          datasets:[
            {label:'CELI', data:annualData.map(d=>d.celi), borderColor:'rgba(0,196,140,0.8)', backgroundColor:'rgba(0,196,140,0.4)', fill:true},
            {label:'REER', data:annualData.map(d=>d.reer), borderColor:'rgba(26,115,232,0.8)', backgroundColor:'rgba(26,115,232,0.4)', fill:true},
            {label:'CRI', data:annualData.map(d=>d.cri), borderColor:'rgba(255,193,7,0.8)', backgroundColor:'rgba(255,193,7,0.4)', fill:true},
            {label:'Non Enregistré', data:annualData.map(d=>d.nonReg), borderColor:'rgba(220,53,69,0.8)', backgroundColor:'rgba(220,53,69,0.4)', fill:true}
          ]
        },
        options:{
          responsive:true,
          plugins:{legend:{position:'top'}},
          interaction:{mode:'index', intersect:false},
          stacked:true,
          scales:{y:{beginAtZero:true}}
        }
      });
    }
  </script>
</body>
</html>
