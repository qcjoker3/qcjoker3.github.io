<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculatrice Retraite Optimisée</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>Calculatrice Retraite Optimisée</h1>
  <nav>
    <a href="#infos">Infos personnelles</a>
    <a href="#comptes">Comptes</a>
    <a href="#scenarios">Scénarios</a>
    <a href="#resultats">Résultats</a>
  </nav>
</header>

<div class="container">

  <!-- Informations personnelles -->
  <section id="infos" class="card-grid">
    <div class="card">
      <h3>Informations personnelles</h3>
      <div class="form-group">
        <label>Âge actuel</label>
        <input type="number" id="ageActuel" value="40">
      </div>
      <div class="form-group">
        <label>Âge de retraite souhaité</label>
        <input type="number" id="ageRetraite" value="65">
      </div>
      <div class="form-group">
        <label>Salaire annuel actuel</label>
        <input type="number" id="salaireActuel" value="80000">
      </div>
      <div class="form-group">
        <label>Revenu désiré à la retraite</label>
        <select id="choixRevenu">
          <option value="70">70% du salaire actuel</option>
          <option value="80">80% du salaire actuel</option>
          <option value="manuel">Manuel</option>
        </select>
      </div>
      <div class="form-group" id="revenuManuelGroup">
        <label>Montant manuel</label>
        <input type="number" id="revenuManuel">
      </div>
    </div>
  </section>

  <!-- Comptes -->
  <section id="comptes" class="card-grid">
    <div class="card">
      <h3>Montants et cotisations</h3>
      <div class="form-group">
        <label>CELI initial</label>
        <input type="number" id="celiInit" value="50000">
      </div>
      <div class="form-group">
        <label>REER initial</label>
        <input type="number" id="reerInit" value="150000">
      </div>
      <div class="form-group">
        <label>CRI initial</label>
        <input type="number" id="criInit" value="100000">
      </div>
      <div class="form-group">
        <label>Non-enregistré initial</label>
        <input type="number" id="nonInit" value="20000">
      </div>

      <div class="form-group">
        <label>Rendement CELI (%)</label>
        <input type="number" id="celiRendement" value="5">
      </div>
      <div class="form-group">
        <label>Rendement REER (%)</label>
        <input type="number" id="reerRendement" value="5">
      </div>
      <div class="form-group">
        <label>Rendement CRI (%)</label>
        <input type="number" id="criRendement" value="5">
      </div>
      <div class="form-group">
        <label>Rendement Non-enregistré (%)</label>
        <input type="number" id="nonRendement" value="4">
      </div>

      <div class="form-group">
        <label>Cotisation annuelle CELI</label>
        <input type="number" id="celiCot" value="6000">
      </div>
      <div class="form-group">
        <label>Cotisation annuelle REER</label>
        <input type="number" id="reerCot" value="18000">
      </div>
      <div class="form-group">
        <label>Cotisation annuelle CRI</label>
        <input type="number" id="criCot" value="0" disabled>
      </div>
      <div class="form-group">
        <label>Cotisation annuelle Non-enregistré</label>
        <input type="number" id="nonCot" value="5000">
      </div>
    </div>
  </section>

  <!-- Scénarios -->
  <section id="scenarios" class="card-grid">
    <div class="card">
      <h3>Scénarios</h3>
      <div class="scenario-btns">
        <button class="scenario-btn active" data-scenario="max">Maximiser durée du capital</button>
        <button class="scenario-btn" data-scenario="impot">Minimiser impôt</button>
        <button class="scenario-btn" data-scenario="esperance">Espérance de vie</button>
      </div>
    </div>
  </section>

  <!-- Résultats -->
  <section id="resultats">
    <div id="totalCapitalCard">
      <h2>Total restant</h2>
      <p id="totalRestant">$0</p>
      <h3>Impôt total payé</h3>
      <p id="impotTotal">$0</p>
    </div>
    <canvas id="chartCapital" width="800" height="400"></canvas>
    <div id="tableauResultats" class="card">
      <h3>Tableau annuel</h3>
      <table id="tableauAnnuel">
        <thead>
          <tr>
            <th>Année</th>
            <th>CELI</th>
            <th>REER</th>
            <th>CRI</th>
            <th>Non-enregistré</th>
            <th>Total</th>
            <th>Impôt payé</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="form-group">
    <button class="btn-primary" id="calculerBtn">Calculer</button>
  </div>

</div>

<script>
const scenarioBtns = document.querySelectorAll('.scenario-btn');
let scenarioActif = 'max';

scenarioBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    scenarioBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    scenarioActif = btn.dataset.scenario;
    calculer();
  });
});

const choixRevenu = document.getElementById('choixRevenu');
const revenuManuelGroup = document.getElementById('revenuManuelGroup');
choixRevenu.addEventListener('change', () => {
  if (choixRevenu.value === 'manuel') {
    revenuManuelGroup.style.display = 'block';
  } else {
    revenuManuelGroup.style.display = 'none';
    document.getElementById('revenuManuel').value = '';
  }
});

let chart;

document.getElementById('calculerBtn').addEventListener('click', calculer);

function calculer() {
  // Récupération des valeurs
  const ageActuel = parseInt(document.getElementById('ageActuel').value);
  const ageRetraite = parseInt(document.getElementById('ageRetraite').value);
  const salaireActuel = parseFloat(document.getElementById('salaireActuel').value);

  let revenuDesire = 0;
  const choix = choixRevenu.value;
  if (choix === '70') revenuDesire = salaireActuel * 0.7;
  else if (choix === '80') revenuDesire = salaireActuel * 0.8;
  else revenuDesire = parseFloat(document.getElementById('revenuManuel').value || 0);

  // Comptes initiaux et cotisations
  const comptes = {
    celi: { init: parseFloat(document.getElementById('celiInit').value), cot: parseFloat(document.getElementById('celiCot').value), rendement: parseFloat(document.getElementById('celiRendement').value) },
    reer: { init: parseFloat(document.getElementById('reerInit').value), cot: parseFloat(document.getElementById('reerCot').value), rendement: parseFloat(document.getElementById('reerRendement').value) },
    cri: { init: parseFloat(document.getElementById('criInit').value), cot: parseFloat(document.getElementById('criCot').value), rendement: parseFloat(document.getElementById('criRendement').value) },
    non: { init: parseFloat(document.getElementById('nonInit').value), cot: parseFloat(document.getElementById('nonCot').value), rendement: parseFloat(document.getElementById('nonRendement').value) }
  };

  // Indexation salaire et RRQ/PSV
  const index = 0.02; // 2% par année
  let salaire = salaireActuel;
  let psv = 700; // montant mensuel approximatif
  let rrq = 1000;

  const annees = [];
  const tableauData = [];

  const totalAnnuel = [];
  const impotAnnuel = [];

  const anneeMax = 100; // jusqu'à 100 ans
  let comptesAnnee = { ...comptes };
  let totalImpots = 0;

  for (let age = ageActuel; age <= anneeMax; age++) {
    // Croissance du salaire et revenus indexés
    if (age < ageRetraite) salaire *= (1 + index);

    // Croissance des comptes avec cotisations
    for (let key in comptesAnnee) {
      if (age < ageRetraite) comptesAnnee[key].init = comptesAnnee[key].init * (1 + comptesAnnee[key].rendement/100) + (key!=='cri'?comptesAnnee[key].cot:0);
      else comptesAnnee[key].init = comptesAnnee[key].init * (1 + comptesAnnee[key].rendement/100);
    }

    // Décaissement selon scénario
    let decaissement = 0;
    if (age >= ageRetraite) decaissement = revenuDesire;

    // Impôt approximatif (simplifié)
    let impot = decaissement * 0.25; // 25% moyenne simplifiée
    totalImpots += impot;

    // Retirer impôt du compte non-enregistré d'abord
    if (decaissement > 0) {
      if (comptesAnnee.non.init >= decaissement) comptesAnnee.non.init -= decaissement + impot;
      else {
        let restant = decaissement - comptesAnnee.non.init;
        comptesAnnee.non.init = 0;
        comptesAnnee.celi.init = Math.max(comptesAnnee.celi.init - restant - impot,0);
      }
    }

    const totalComptes = comptesAnnee.celi.init + comptesAnnee.reer.init + comptesAnnee.cri.init + comptesAnnee.non.init;

    // Stop si tout est à zéro après retraite
    if (totalComptes <= 0 && age >= ageRetraite) break;

    annees.push(age);
    tableauData.push({ age, ...comptesAnnee, total: totalComptes, impot });
    totalAnnuel.push(totalComptes);
    impotAnnuel.push(impot);
  }

  // Mise à jour des totaux
  document.getElementById('totalRestant').textContent = '$' + Math.round(totalAnnuel[totalAnnuel.length-1]);
  document.getElementById('impotTotal').textContent = '$' + Math.round(totalImpots);

  // Graphique
  const datasets = [
    { label: 'CELI', data: tableauData.map(d=>d.celi.init), backgroundColor: 'rgba(0,196,140,0.5)', borderColor: 'rgba(0,196,140,0.8)' },
    { label: 'REER', data: tableauData.map(d=>d.reer.init), backgroundColor: 'rgba(26,115,232,0.5)', borderColor: 'rgba(26,115,232,0.8)' },
    { label: 'CRI', data: tableauData.map(d=>d.cri.init), backgroundColor: 'rgba(255,193,7,0.5)', borderColor: 'rgba(255,193,7,0.8)' },
    { label: 'Non-enregistré', data: tableauData.map(d=>d.non.init), backgroundColor: 'rgba(220,53,69,0.5)', borderColor: 'rgba(220,53,69,0.8)' }
  ];

  if(chart) chart.destroy();
  const ctx = document.getElementById('chartCapital').getContext('2d');
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels: annees, datasets: datasets },
    options: {
      responsive:true,
      scales: { x:{ stacked:true }, y:{ stacked:true } }
    }
  });

  // Tableau annuel
  const tbody = document.querySelector('#tableauAnnuel tbody');
  tbody.innerHTML = '';
  tableauData.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.age}</td>
      <td>${Math.round(d.celi.init)}</td>
      <td>${Math.round(d.reer.init)}</td>
      <td>${Math.round(d.cri.init)}</td>
      <td>${Math.round(d.non.init)}</td>
      <td>${Math.round(d.total)}</td>
      <td>${Math.round(d.impot)}</td>
    `;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
