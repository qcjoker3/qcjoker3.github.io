<div class="container">

  <!-- Section revenus -->
  <div class="card">
    <h3>Salaire actuel</h3>
    <input type="number" id="currentSalary" placeholder="Ex. 85000">

    <h3>Revenu désiré à la retraite</h3>
    <div id="incomeOptionsContainer">
      <label><input type="radio" name="incomeOption" value="70" checked> 70%</label>
      <label><input type="radio" name="incomeOption" value="80"> 80%</label>
      <label><input type="radio" name="incomeOption" value="manual"> Manuel</label>
    </div>
    <input type="number" id="manualIncome" placeholder="Entrez le montant souhaité" style="display:none;">
  </div>

  <!-- Section comptes -->
  <div class="card-grid">
    <div class="card">
      <h3>CELI</h3>
      <input type="number" id="celiCurrent" placeholder="Montant actuel">
      <input type="number" id="celiContribution" placeholder="Cotisation annuelle">
      <input type="number" id="celiReturn" placeholder="Rendement (%)">
    </div>
    <div class="card">
      <h3>REER</h3>
      <input type="number" id="reerCurrent" placeholder="Montant actuel">
      <input type="number" id="reerContribution" placeholder="Cotisation annuelle">
      <input type="number" id="reerReturn" placeholder="Rendement (%)">
    </div>
    <div class="card">
      <h3>CRI</h3>
      <input type="number" id="criCurrent" placeholder="Montant actuel">
      <input type="number" id="criContribution" placeholder="Cotisation annuelle">
      <input type="number" id="criReturn" placeholder="Rendement (%)">
    </div>
    <div class="card">
      <h3>Non-enregistré</h3>
      <input type="number" id="nonCurrent" placeholder="Montant actuel">
      <input type="number" id="nonContribution" placeholder="Cotisation annuelle">
      <input type="number" id="nonReturn" placeholder="Rendement (%)">
    </div>
  </div>

  <!-- Scénarios -->
  <div class="scenario-btns" style="margin:20px 0;">
    <button class="scenario-btn active" data-scenario="maxDuration">Max Durée</button>
    <button class="scenario-btn" data-scenario="minTax">Min Impôt</button>
    <button class="scenario-btn" data-scenario="lifeExpectancy">Espérance de vie</button>
  </div>

  <!-- Graphique -->
  <canvas id="accountChart" width="900" height="400"></canvas>

  <!-- Tableau -->
  <div id="accountsTableContainer"></div>

  <!-- Bouton calcul -->
  <button class="btn-primary" onclick="calculate()">Calculer</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const incomeRadios = document.querySelectorAll('input[name="incomeOption"]');
const manualIncome = document.getElementById('manualIncome');

// Affichage ou masquage du champ manuel
incomeRadios.forEach(radio => {
  radio.addEventListener('change', () => {
    manualIncome.style.display = (radio.value === 'manual') ? 'block' : 'none';
    if(radio.value === 'manual') manualIncome.value = '';
  });
});

const scenarioButtons = document.querySelectorAll('.scenario-btn');
let selectedScenario = 'maxDuration';
scenarioButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    scenarioButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedScenario = btn.dataset.scenario;
    calculate(); // recalculer quand on change le scénario
  });
});

function getDesiredIncome(currentSalary){
  let selectedValue;
  incomeRadios.forEach(radio => { if(radio.checked) selectedValue = radio.value; });

  if(selectedValue === '70') return currentSalary * 0.7;
  if(selectedValue === '80') return currentSalary * 0.8;
  return parseFloat(manualIncome.value) || 0;
}

function calculate(){
  const currentSalary = parseFloat(document.getElementById('currentSalary').value) || 0;
  const desiredIncome = getDesiredIncome(currentSalary);

  // Récupération des comptes
  const accounts = {
    celi: {current: parseFloat(document.getElementById('celiCurrent').value) || 0, contribution: parseFloat(document.getElementById('celiContribution').value) || 0, return: parseFloat(document.getElementById('celiReturn').value)/100 || 0},
    reer: {current: parseFloat(document.getElementById('reerCurrent').value) || 0, contribution: parseFloat(document.getElementById('reerContribution').value) || 0, return: parseFloat(document.getElementById('reerReturn').value)/100 || 0},
    cri: {current: parseFloat(document.getElementById('criCurrent').value) || 0, contribution: parseFloat(document.getElementById('criContribution').value) || 0, return: parseFloat(document.getElementById('criReturn').value)/100 || 0},
    non: {current: parseFloat(document.getElementById('nonCurrent').value) || 0, contribution: parseFloat(document.getElementById('nonContribution').value) || 0, return: parseFloat(document.getElementById('nonReturn').value)/100 || 0},
  };

  // Simulation sur 40 ans (exemple)
  const years = Array.from({length:40}, (_,i)=>i+1);
  let accountsByYear = [];
  let tempAccounts = JSON.parse(JSON.stringify(accounts));

  years.forEach((y, idx)=>{
    // croissance
    for(let key in tempAccounts){
      tempAccounts[key].current += tempAccounts[key].current*tempAccounts[key].return + tempAccounts[key].contribution;
      if(tempAccounts[key].current<0) tempAccounts[key].current=0;
    }
    accountsByYear.push({
      year: new Date().getFullYear()+y-1,
      celi: tempAccounts.celi.current,
      reer: tempAccounts.reer.current,
      cri: tempAccounts.cri.current,
      non: tempAccounts.non.current
    });
  });

  renderChart(accountsByYear);
  renderTable(accountsByYear);
}

function renderChart(accountsByYear){
  const ctx = document.getElementById('accountChart').getContext('2d');
  const data = {
    labels: accountsByYear.map(d=>d.year),
    datasets: [
      {label:'CELI', data:accountsByYear.map(d=>d.celi), backgroundColor:'rgba(0,196,140,0.5)'},
      {label:'REER', data:accountsByYear.map(d=>d.reer), backgroundColor:'rgba(26,115,232,0.5)'},
      {label:'CRI', data:accountsByYear.map(d=>d.cri), backgroundColor:'rgba(255,193,7,0.5)'},
      {label:'Non-enregistré', data:accountsByYear.map(d=>d.non), backgroundColor:'rgba(220,53,69,0.5)'}
    ]
  };
  if(window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx,{
    type:'bar',
    data:data,
    options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{x:{stacked:true}, y:{stacked:true}}}
  });
}

function renderTable(accountsByYear){
  const tableContainer = document.getElementById('accountsTableContainer');
  let html = '<table><thead><tr><th>Année</th><th>CELI</th><th>REER</th><th>CRI</th><th>Non-enregistré</th><th>Total</th></tr></thead><tbody>';

  for(const yearData of accountsByYear){
    const total = yearData.celi + yearData.reer + yearData.cri + yearData.non;
    if(total<=0) break;
    html += `<tr>
      <td>${yearData.year}</td>
      <td>${yearData.celi.toFixed(2)}</td>
      <td>${yearData.reer.toFixed(2)}</td>
      <td>${yearData.cri.toFixed(2)}</td>
      <td>${yearData.non.toFixed(2)}</td>
      <td>${total.toFixed(2)}</td>
    </tr>`;
  }

  html += '</tbody></table>';
  tableContainer.innerHTML = html;
}

// Initial calculation
calculate();
</script>
