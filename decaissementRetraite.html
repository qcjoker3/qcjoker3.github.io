<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculatrice - Planification financière</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="container">
    <h1>Finoza</h1>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="#services">Services</a>
        <a href="Prédictions.html">Prédictions</a>
        <a href="calculatrices.html">Calculatrices</a>
        <a href="gestionActive.html">Gestion active</a>
        <a href="decaissementRetraite.html">Décaissement retraite</a>
        <a href="blog.html">Articles</a>
        <a href="#contact">Contact</a>
    </nav>
</header>

  <div class="container">
    <!-- ===== 6 BLOCS HORIZONTAUX ===== -->
    <div class="card-grid">
      <!-- Bloc 1: Infos personne -->
      <div class="card">
        <h3>Profil & inflation</h3>
        <div class="form-group"><label>Âge actuel</label><input type="number" id="ageActuel" value="40" /></div>
        <div class="form-group"><label>Âge de retraite</label><input type="number" id="ageRetraite" value="65" /></div>
        <div class="form-group"><label>Salaire actuel ($/an)</label><input type="number" id="salaireActuel" value="80000" /></div>
        <div class="form-group"><label>Inflation annuelle (%)</label><input type="number" id="inflation" value="2.0" /></div>
        <div class="form-group">
          <label>Revenu désiré à la retraite</label>
          <select id="revenuChoix">
            <option value="70" selected>70% du salaire (indexé)</option>
            <option value="80">80% du salaire (indexé)</option>
            <option value="manuel">Montant manuel (indexé)</option>
          </select>
        </div>
        <div id="revenuManuelGroup" class="form-group" style="display:none">
          <label>Montant annuel (valeur actuelle)</label>
          <input type="number" id="revenuManuel" placeholder="Ex. 55000" />
        </div>
        <div class="form-group">
          <label>Espérance de vie cible</label>
          <select id="esperanceVie">
            <option value="70">Courte (70 ans)</option>
            <option value="85" selected>Moyenne (85 ans)</option>
            <option value="100">Longue (100 ans)</option>
          </select>
        </div>
      </div>

      <!-- Bloc 2: Soldes & cotisations -->
      <div class="card">
        <h3>Soldes actuels</h3>
        <div class="form-group"><label>CELI actuel</label><input type="number" id="celiActuel" value="50000" /></div>
        <div class="form-group"><label>REER actuel</label><input type="number" id="reerActuel" value="120000" /></div>
        <div class="form-group"><label>CRI actuel</label><input type="number" id="criActuel" value="60000" /></div>
        <div class="form-group"><label>Non-enregistré actuel</label><input type="number" id="nonActuel" value="40000" /></div>
      </div>

      <!-- Bloc 3: Rendements -->
      <div class="card">
        <h3>Cotisations</h3>
        <div class="form-group"><label>Cotisation annuelle CELI</label><input type="number" id="celiCot" value="6000" /></div>
        <div class="form-group"><label>Cotisation annuelle REER</label><input type="number" id="reerCot" value="10000" /></div>
        <div class="form-group"><label>Cotisation annuelle CRI</label><input type="number" id="criCot" value="5000" /></div>
        <div class="form-group"><label>Cotisation annuelle Non-enreg.</label><input type="number" id="nonCot" value="0" /></div>
      </div>
      
      <!-- Bloc 4: Rendements -->
      <div class="card">
        <h3>Rendements</h3>
        <div class="form-group"><label>Rendement CELI (%)</label><input type="number" id="celiRend" value="5" /></div>
        <div class="form-group"><label>Rendement REER (%)</label><input type="number" id="reerRend" value="6" /></div>
        <div class="form-group"><label>Rendement CRI (%)</label><input type="number" id="criRend" value="5.5" /></div>
        <div class="form-group"><label>Rendement Non-enreg. (%)</label><input type="number" id="nonRend" value="4" /></div>
      </div>

      <!-- Bloc 5: RRQ & PSV -->
      <div class="card">
        <h3>RRQ & PSV</h3>
        <div class="form-group"><label>RRQ à 65 ans (mensuel)</label><input type="number" id="rrq65" value="1000" /></div>
        <div class="form-group"><label>PSV à 65 ans (mensuel)</label><input type="number" id="psv65" value="800" /></div>
        <div class="form-group"><label>Âge de retrait RRQ</label><input type="number" id="ageRRQ" value="65" /></div>
        <div class="form-group"><label>Âge de retrait PSV</label><input type="number" id="agePSV" value="65" /></div>

        <details class="advanced-options" style="margin-top:10px">
          <summary>Options avancées RRQ/PSV & FRV/FERR</summary>
          <div class="form-section">
            <div class="form-group"><label>RRQ : réduction/mois avant 65 (%)</label><input type="number" id="rrqRedPct" value="0.6" /></div>
            <div class="form-group"><label>RRQ : bonification/mois après 65 (%)</label><input type="number" id="rrqBonPct" value="0.7" /></div>
            <div class="form-group"><label>PSV : seuil de récupération de départ ($)</label><input type="number" id="oasThresholdBase" value="93454" /></div>
            <div class="form-group"><label>Taux de récupération PSV (%)</label><input type="number" id="oasClawRate" value="15" /></div>
            <div class="form-group"><label>Appliquer règles FERR/FRV dès 71 ans</label>
              <select id="applyRrifLif">
                <option value="1" selected>Oui</option>
                <option value="0">Non</option>
              </select>
            </div>
            <div class="form-group"><label>Taux de référence FRV (%)</label><input type="number" id="lifRefRate" value="6" /></div>
          </div>
        </details>
      </div>

      <!-- Bloc 6: Fonds de pension -->
      <div class="card">
        <div class="form-group">
        <h3>Fonds de pension</h3>
          <select id="pensionChoix">
            <option value="oui">Oui</option>
            <option value="non" selected>Non</option>
          </select>
        </div>
        <div id="fondPensionGroup" class="form-group" style="display:none">
          <label>Salaire garanti ($ actuel)</label><input type="number" id="salairePension" value="0" />
          <label>Indexation annuelle (%)</label><input type="number" id="indexPension" value="2" />
        </div>
    </div>
  </div>
  <!-- Fiscalité -->
  <div class="card" style="display:none">
    <h3>Fiscalité (paliers éditables, indexés par inflation)</h3>
    <p class="helper">Listes JSON <code>[[plafond, taux], ...]</code> — plafonds indexés chaque année.</p>
    <div class="card-grid">
      <div class="form-group">
        <label>Fédéral 2025</label>
        <input id="fedBrackets" value='[[55867,0.15],[111733,0.205],[173206,0.26],[246752,0.29],[Infinity,0.33]]' />
      </div>
      <div class="form-group">
        <label>Québec 2025</label>
        <input id="qcBrackets" value='[[51780,0.145],[103545,0.20],[126000,0.24],[Infinity,0.2575]]' />
      </div>
      <div class="form-group">
        <label>Crédit de base combiné ($, optionnel)</label>
        <input id="basicCredit" value="0" />
      </div>
    </div>
  </div>

  <!-- Événements -->
  <div class="card">
    <h3>Événements financiers</h3>
    <div id="evenementsContainer"></div>
    <button id="ajoutEvenement" class="btn-primary" type="button">Ajouter un événement</button>
    <p class="helper">Un événement = âge (année) et montant +/-.</p>
  </div>

  <!-- Scénarios -->
  <div class="card">
    <h3>Scénarios de décaissement</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap";width: 100%;>
      <button class="btn-primary scenario" data-s="durée">Maximiser la durée</button>
      <button class="btn-primary scenario" data-s="impot">Minimiser l’impôt total</button>
      <button class="btn-primary scenario" data-s="espvie">Maximiser les retraits</button>
    </div>
    <p id="bestOrders" class="helper" style="margin-top:10px"></p>
  </div>

  <!-- Résultats & Graphique -->

  <div class="card">
    <h3>Indicateurs</h3>
    <div class="results-dashboard">
      <div class="result-box"><span class="result-label">Capital de fin</span><span class="result-value" id="totalRestant">$0</span></div>
      <div class="result-box"><span class="result-label">Âge d'épuisement du capital</span><span class="result-value" id="ageFin">0</span></div>
      <div class="result-box"><span class="result-label">Impôt cumulé</span><span class="result-value" id="totalImpot">$0</span></div>
      <div class="result-box"><span class="result-label">Dépenses totales</span><span class="result-value" id="depensesCumulees">$0</span></div>
    </div>
  </div>
  
  <div class="card">
    <h3>Valeurs des comptes</h3>
    <div class="chart-container">
      <canvas id="graphiqueSoldes" height="380"></canvas>
    </div>
  </div>


  <div class="card">
    <h3>Table des retraits</h3>
    <div style="max-height:420px;overflow:auto;border-radius:12px">
      <table id="tableauAnnuel"; width: calc(100% / 10);>
        <thead>
          <tr>
            <th>Âge</th>
            <th>Salaire désiré</th>
            <th>Revenus (RRQ+PSV+évén.+)</th>
            <th>Retraits nets</th>
            <th>Impôt</th>
            <th>Retraits bruts</th>
            <th>CELI</th>
            <th>REER</th>
            <th>CRI</th>
            <th>Non-enreg.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
    // --- Constantes et utilitaires ---
  const AGE_MAX = 100;
  const INFLATION_DEFAULT = 0.02;
  
  // --- Gestion affichage revenu manuel ---
  const revenuChoix = document.getElementById('revenuChoix');
  const revenuManuelGroup = document.getElementById('revenuManuelGroup');
  revenuChoix.addEventListener('change', e => {
    revenuManuelGroup.style.display = e.target.value === 'manuel' ? 'block' : 'none';
  });
  
  // --- Gestion affichage fonds de pension ---
  const pensionChoix = document.getElementById('pensionChoix');
  const fondPensionGroup = document.getElementById('fondPensionGroup');
  pensionChoix.addEventListener('change', e => {
    fondPensionGroup.style.display = e.target.value === 'oui' ? 'block' : 'none';
  });
  
  // --- Gestion événements financiers ---
  const evenementsContainer = document.getElementById('evenementsContainer');
  const ajoutEvenementBtn = document.getElementById('ajoutEvenement');
  ajoutEvenementBtn.addEventListener('click', () => {
    if (evenementsContainer.children.length >= 4) return;
    const div = document.createElement('div');
    div.classList.add('evenement');
    div.innerHTML = `
      <input type="number" class="anneeEvenement" placeholder="Âge"/>
      <input type="number" class="montantEvenement" placeholder="Montant"/>
      <button type="button" class="supprimer">X</button>
    `;
    div.querySelector('.supprimer').addEventListener('click', ()=>div.remove());
    evenementsContainer.appendChild(div);
  });
  
  // --- Scénario sélection ---
  let scenarioChoisi = 'durée';
  document.querySelectorAll('.scenario').forEach(btn=>{
    btn.addEventListener('click', e=>{
      scenarioChoisi = e.currentTarget.dataset.s;
      document.getElementById('bestOrders').innerText = `Scénario sélectionné : ${scenarioChoisi}`;
      calculer();
    });
  });
  
  // --- Fonction utilitaire inflation ---
  function appliquerInflation(montant, annees, inflation) {
    return montant * Math.pow(1 + inflation, annees);
  }
  
  // --- Fonction impôt simplifié ---
  function calculerImpot(retraitREER,retraitNon,retraitCRI,fedBrackets,qcBrackets){
    let revenuOrdinaire = retraitREER + retraitCRI;
    let gainNon = retraitNon/2; // 50% inclus pour gain en capital
    revenuOrdinaire += retraitNon - gainNon;
    let impFed=0, impQc=0, restant=revenuOrdinaire, last=0;
    fedBrackets.forEach(b=>{
      const taxable=Math.min(restant,b[0]-last);
      if(taxable>0) impFed+=taxable*b[1];
      restant-=taxable; last=b[0];
    });
    restant=revenuOrdinaire; last=0;
    qcBrackets.forEach(b=>{
      const taxable=Math.min(restant,b[0]-last);
      if(taxable>0) impQc+=taxable*b[1];
      restant-=taxable; last=b[0];
    });
    return impFed+impQc;
  }
  
  // --- Permutations ---
  function getPermutations(array){
    if(array.length===1) return [array];
    const perms=[];
    array.forEach((v,i)=>{
      const rest=array.slice(0,i).concat(array.slice(i+1));
      getPermutations(rest).forEach(p=>perms.push([v,...p]));
    });
    return perms;
  }
  
  // --- Décaissement optimisé ---
  function decaissementOptimise(revenu, soldeREER, soldeCELI, soldeNon, soldeCRI, scenario, fedBrackets, qcBrackets){
    const comptes=['REER','CELI','Non','CRI'];
    const permutations = getPermutations(comptes);
    let meilleur=null;
    permutations.forEach(ord=>{
      let sREER=soldeREER,sCELI=soldeCELI,sNon=soldeNon,sCRI=soldeCRI;
      let retrait={REER:0,CELI:0,Non:0,CRI:0};
      let restant=revenu;
      ord.forEach(c=>{
        let r=0;
        if(c==='REER') r=Math.min(sREER,restant);
        if(c==='CELI') r=Math.min(sCELI,restant);
        if(c==='Non') r=Math.min(sNon,restant);
        if(c==='CRI') r=Math.min(sCRI,restant);
        if(c==='REER') sREER-=r;
        if(c==='CELI') sCELI-=r;
        if(c==='Non') sNon-=r;
        if(c==='CRI') sCRI-=r;
        retrait[c]=r; restant-=r;
      });
      let score;
      if(scenario==='durée') score=sREER+sCELI+sNon+sCRI;
      else if(scenario==='impot') score=-calculerImpot(retrait.REER,retrait.Non,retrait.CRI,fedBrackets,qcBrackets);
      else if(scenario==='espvie') score=-Math.abs(sREER+sCELI+sNon+sCRI);
      if(!meilleur || score>meilleur.score){
        meilleur={retrait, sREER, sCELI, sNon, sCRI, score};
      }
    });
    return meilleur;
  }
  
  // --- Calcul principal ---
  function calculer(){
    const ageActuel = parseInt(document.getElementById('ageActuel').value);
    const ageRetraite = parseInt(document.getElementById('ageRetraite').value);
    const inflation = parseFloat(document.getElementById('inflation').value)/100 || INFLATION_DEFAULT;
    const salaireActuel = parseFloat(document.getElementById('salaireActuel').value);
  
    let revenuDesire = 0;
    const choix = document.getElementById('revenuChoix').value;
    if(choix==='manuel') revenuDesire=parseFloat(document.getElementById('revenuManuel').value)||0;
    else revenuDesire=salaireActuel*(parseInt(choix)/100);
  
    const esperanceVie = parseInt(document.getElementById('esperanceVie').value);
  
    // Soldes initiaux
    let balances={
      REER: parseFloat(document.getElementById('reerActuel').value),
      CELI: parseFloat(document.getElementById('celiActuel').value),
      CRI: parseFloat(document.getElementById('criActuel').value),
      Non: parseFloat(document.getElementById('nonActuel').value),
      RRIF:0, FRV:0
    };
  
    // Cotisations annuelles (sans inflation)
    const cotations={
      REER: parseFloat(document.getElementById('reerCot').value),
      CELI: parseFloat(document.getElementById('celiCot').value),
      CRI: parseFloat(document.getElementById('criCot').value),
      Non: parseFloat(document.getElementById('nonCot').value)
    };
  
    // Rendements
    const rendements={
      REER: parseFloat(document.getElementById('reerRend').value)/100,
      CELI: parseFloat(document.getElementById('celiRend').value)/100,
      CRI: parseFloat(document.getElementById('criRend').value)/100,
      Non: parseFloat(document.getElementById('nonRend').value)/100
    };
  
    // RRQ/PSV avancé
    const rrq=parseFloat(document.getElementById('rrq65').value)*12;
    const psv=parseFloat(document.getElementById('psv65').value)*12;
    const rrqRedPct=parseFloat(document.getElementById('rrqRedPct').value)/100 || 0.006;
    const rrqBonPct=parseFloat(document.getElementById('rrqBonPct').value)/100 || 0.007;
    const oasThresholdBase=parseFloat(document.getElementById('oasThresholdBase').value)||0;
    const oasClawRate=parseFloat(document.getElementById('oasClawRate').value)/100||0.15;
    const applyRrifLif=document.getElementById('applyRrifLif').value==='1';
    const lifRefRate=parseFloat(document.getElementById('lifRefRate').value)/100||0.06;
  
    // Fonds de pension
    const pensionOui=pensionChoix.value==='oui';
    let salairePension = pensionOui ? parseFloat(document.getElementById('salairePension').value)||0 : 0;
    const indexPension = pensionOui ? parseFloat(document.getElementById('indexPension').value)/100||0.02 : 0;
  
    // Fiscalité
    const fedBrackets = JSON.parse(document.getElementById('fedBrackets').value);
    const qcBrackets = JSON.parse(document.getElementById('qcBrackets').value);
  
    // Événements financiers
    const evenements=[];
    document.querySelectorAll('.evenement').forEach(ev=>{
      const an=parseInt(ev.querySelector('.anneeEvenement').value);
      const mt=parseFloat(ev.querySelector('.montantEvenement').value);
      if(!isNaN(an)&&!isNaN(mt)) evenements.push({annee:an,montant:mt});
    });
  
    // Tableau résultats
    const tableau=[];
    let totalImpot=0, totalDepenses=0;
    let ageFinCapital=ageRetraite;
  
    for(let age=ageRetraite; age<=AGE_MAX; age++){
      const annee=age-ageRetraite;
  
      // --- Appliquer cotisations annuelles (sans inflation) ---
      balances.REER += cotations.REER;
      balances.CELI += cotations.CELI;
      balances.CRI += cotations.CRI;
      balances.Non += cotations.Non;
  
      // --- Appliquer rendement annuel ---
      balances.REER *= (1+rendements.REER);
      balances.CELI *= (1+rendements.CELI);
      balances.CRI *= (1+rendements.CRI);
      balances.Non *= (1+rendements.Non);
  
      // --- Revenu annuel ---
      let revenuAnnee = appliquerInflation(revenuDesire, annee, inflation);
  
      // Ajouter RRQ/PSV ajusté
      let rrqAn=rrq, psvAn=psv;
      if(age<65) rrqAn *= 1 - (65-age)*rrqRedPct;
      if(age>65) rrqAn *= 1 + (age-65)*rrqBonPct;
      psvAn *= Math.pow(1+inflation,age-65);
      if(psvAn>oasThresholdBase) psvAn -= (psvAn-oasThresholdBase)*oasClawRate;
  
      revenuAnnee += rrqAn + psvAn;
  
      // Ajouter fonds de pension indexé
      if(pensionOui) revenuAnnee += salairePension*Math.pow(1+indexPension, annee);
  
      // Événements financiers
      evenements.forEach(ev=>{if(ev.annee===age) revenuAnnee+=ev.montant;});
  
      // Conversion RRIF/FRV à 71 ans
      if(age===71 && applyRrifLif){
        balances.RRIF=balances.REER; balances.REER=0;
        balances.FRV=balances.CRI; balances.CRI=0;
      }
  
      // Décaissement optimisé
      const decaissement=decaissementOptimise(revenuAnnee,balances.REER,balances.CELI,balances.Non,balances.CRI,scenarioChoisi,fedBrackets,qcBrackets);
      balances.REER=decaissement.sREER;
      balances.CELI=decaissement.sCELI;
      balances.Non=decaissement.sNon;
      balances.CRI=decaissement.sCRI;
  
      const impAnnee=calculerImpot(decaissement.retrait.REER,decaissement.retrait.Non,decaissement.retrait.CRI,fedBrackets,qcBrackets);
      totalImpot+=impAnnee;
      totalDepenses+=revenuAnnee;
  
      tableau.push({
        age,
        salaire:appliquerInflation(revenuDesire,annee,inflation),
        revenus:revenuAnnee,
        retraitsNet:decaissement.retrait.REER+decaissement.retrait.CELI+decaissement.retrait.Non+decaissement.retrait.CRI,
        impot:impAnnee,
        retraitsBrut:decaissement.retrait.REER+decaissement.retrait.Non+decaissement.retrait.CRI+decaissement.retrait.CELI,
        CELI:balances.CELI,
        REER:balances.REER,
        CRI:balances.CRI,
        Non:balances.Non
      });
  
      if(balances.REER+balances.CELI+balances.Non+balances.CRI<=0){ageFinCapital=age; break;}
    }
  
    // --- Affichage résultats ---
    document.getElementById('totalRestant').innerText='$'+(balances.REER+balances.CELI+balances.CRI+balances.Non).toFixed(0);
    document.getElementById('ageFin').innerText=ageFinCapital;
    document.getElementById('totalImpot').innerText='$'+totalImpot.toFixed(0);
    document.getElementById('depensesCumulees').innerText='$'+totalDepenses.toFixed(0);
  
    // --- Graphique Chart.js ---
    const ctx=document.getElementById('graphiqueSoldes').getContext('2d');
    if(window.chartInstance) window.chartInstance.destroy();
    window.chartInstance=new Chart(ctx,{
      type:'line',
      data:{
        labels:tableau.map(r=>r.age),
        datasets:[
          {label:'CELI', data:tableau.map(r=>r.CELI), borderColor:'green', fill:false},
          {label:'REER', data:tableau.map(r=>r.REER), borderColor:'blue', fill:false},
          {label:'CRI', data:tableau.map(r=>r.CRI), borderColor:'purple', fill:false},
          {label:'Non-enreg.', data:tableau.map(r=>r.Non), borderColor:'orange', fill:false},
          {label:'Total', data:tableau.map(r=>r.CELI+r.REER+r.CRI+r.Non), borderColor:'black', fill:false, borderWidth:2}
        ]
      },
      options:{responsive:true, plugins:{legend:{position:'top'}}}
    });
  
    // --- Tableau ---
    const tbody=document.querySelector('#tableauAnnuel tbody');
    tbody.innerHTML='';
    tableau.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.age}</td>
        <td>${r.salaire.toFixed(0)}</td>
        <td>${r.revenus.toFixed(0)}</td>
        <td>${r.retraitsNet.toFixed(0)}</td>
        <td>${r.impot.toFixed(0)}</td>
        <td>${r.retraitsBrut.toFixed(0)}</td>
        <td>${r.CELI.toFixed(0)}</td>
        <td>${r.REER.toFixed(0)}</td>
        <td>${r.CRI.toFixed(0)}</td>
        <td>${r.Non.toFixed(0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  // --- Calcul initial ---
  calculer();
  </script>
</body>
</html>
