<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Pr√©dictions</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .encadre-texte {
      font-size: 1.1em;
      width: 60%;
      margin: 20px auto;
      padding: 15px;
      text-align: center;
      background-color: #f7f9fa;
      border-radius: 8px;
    }
    .year-selector { text-align: center; margin: 20px 0; }
    #chartContainer { max-width: 960px; margin: auto; }
    #chartCanvas { width: 100%; height: 420px; }
    footer { text-align: center; margin-top: 40px; }

    /* Analyse d√©taill√©e */
    .analysis {
      max-width: 960px;
      margin: 28px auto 60px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    .analysis h3 { margin: 14px 0; }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    .horizon-tabs {
      display: flex; gap: 8px; margin: 6px 0 12px;
    }
    .horizon-tabs button {
      padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer;
    }
    .horizon-tabs button.active {
      background: #111827; color: #fff; border-color: #111827;
    }
    .hint { color: #6b7280; font-size: 0.9em; margin: 6px 0 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 9px 10px; border-bottom: 1px solid #eceff3; text-align: left; }
    th { background: #f7f9fa; position: sticky; top: 0; z-index: 1; }
    .table-wrap { max-height: 340px; overflow: auto; border: 1px solid #eceff3; border-radius: 8px; }
    .rank-badge {
      display: inline-block; min-width: 26px; text-align: center; padding: 2px 6px; border-radius: 999px;
      background: #eef2ff; color: #3730a3; font-weight: 600; font-size: 12px;
    }
    tr.focused { background: #fff7ed; }
    tr:hover { background: #f9fafb; cursor: pointer; }

    #predRealContainer { max-width: 960px; margin: 6px auto; }
    #predRealCanvas { width: 100%; height: 360px; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section>
      <div class="encadre-texte">
        √Ä chaque d√©but d'ann√©e les strat√©gistes des grandes banques et fonds d'investissement d√©voilent leurs pr√©dictions sur le S&P 500 pour l'ann√©e √† venir. Ils sont pay√©s des millions par ann√©e et poss√®dent des mod√®les √©conom√©triques tr√®s avanc√©s. Ils devraient √™tre bons, n'est-ce pas‚ÄØ? Pourtant ann√©e apr√®s ann√©e ils sont toujours √† l'emploi de leur firme √† attendre leur ch√®que aux 2 semaines. Charlatants ou experts? Voyez par vous-m√™mes‚ÄØ!
      </div>

      <h2 style="text-align:center;">Pr√©dictions du S&P 500</h2>

      <!-- Analyse d√©taill√©e -->
      <section class="analysis">
        <h3>Analyse d√©taill√©e</h3>
        <div class="grid-2">
          <div>
            <h4>Classement des institutions</h4>
            <div class="horizon-tabs">
              <button data-h="1" class="active">1 an</button>
              <button data-h="3">3 ans</button>
              <button data-h="5">5 ans</button>
            </div>
            <div class="hint">Classement par √©cart moyen en % sur l‚Äôhorizon choisi, calcul√© √† partir de la derni√®re ann√©e disponible.</div>
            <div class="table-wrap">
              <table id="rankingTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Institution</th>
                    <th>Ann√©es (n)</th>
                    <th>√âcart moyen (%)</th>
                    
                  </tr>
                </thead>
                <tbody><!-- rempli par JS --></tbody>
              </table>
            </div>
          </div>
          <div>
            <h4>Pr√©vision vs R√©alit√© par ann√©e</h4>
            <div class="hint">Affiche la trajectoire de l‚Äôinstitution s√©lectionn√©e (s√©lectionne une ligne du classement).</div>
            <div id="predRealContainer">
              <canvas id="predRealCanvas"></canvas>
            </div>
          </div>
        </div>
      </section>
        <!-- fin Analyse d√©taill√©e -->
      
      <div class="year-selector">
        <label for="yearSelect">üìÖ Ann√©e :</label>
        <select id="yearSelect">
          <option value="">-- S√©lectionner --</option>
          <option value="2020">2020</option>
          <option value="2021">2021</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
        </select>
      </div>

      <div id="chartContainer">
        <canvas id="chartCanvas"></canvas>
      </div>

     </section>
  </main>

  <footer>
    <p>&copy; 2025 - Finoza</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script>
    // Injecte le header
    fetch('header.html')
      .then(res => res.text())
      .then(data => { document.getElementById('header-placeholder').innerHTML = data; });

    // Donn√©es
    const chartDataByYear = {
      "2020": {
        real: 3756,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          3400, 3400, 3300, 3000, 3000, 3300, 3300, 3350, 3250, 3425, 3400, 3500
        ]
      },
      "2021": {
        real: 4766,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          4300, 4400, 3800, 3900, 4100, 4000, 4000, 4100, 3950, 4050, 4200, 4300
        ]
      },
      "2022": {
        real: 3840,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          5100, 5050, 4600, 4400, 4850, 5300, 4800, 5050, 5250, 5200, 5300, 5330
        ]
      },
      "2023": {
        real: 4770,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          4000, 4200, 4000, 3900, 3900, 4400, 4150, 4300, 4500, 4050, 4300, 4400
        ]
      },
      "2024": {
        real: 5882,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "BCA Research", "BMO", "Oppenheimer"
        ],
        previsions: [
          5100, 4200, 5000, 4500, 4700, 4700, 5300, 5000, 5100, 3300, 5100, 5200
        ]
      },
    };

    // Utilitaires
    const yearsSorted = Object.keys(chartDataByYear).sort();
    const idxByYear = (y) => yearsSorted.indexOf(String(y));

    function getWindowYears(endYear, horizonYears) {
      const endIdx = idxByYear(endYear);
      if (endIdx < 0) return [];
      const startIdx = Math.max(0, endIdx - (horizonYears - 1));
      return yearsSorted.slice(startIdx, endIdx + 1);
    }

    function computeYearErrorsPct(year) {
      const d = chartDataByYear[year];
      const { institutions, previsions, real } = d;
      const map = new Map();
      institutions.forEach((inst, i) => {
        const errPct = Math.abs(previsions[i] - real) / real * 100;
        const errPts = Math.abs(previsions[i] - real);
        map.set(inst, { errPct, errPts, pred: previsions[i], real });
      });
      return map; // inst -> {errPct, errPts, pred, real}
    }

    function computeRanking(endYear, horizonYears) {
      const windowYears = getWindowYears(endYear, horizonYears);
      // Agr√®ge par institution
      const stats = new Map(); // inst -> { sumPct, sumPts, n }
      windowYears.forEach(y => {
        const errs = computeYearErrorsPct(y);
        errs.forEach((v, inst) => {
          if (!stats.has(inst)) stats.set(inst, { sumPct: 0, sumPts: 0, n: 0 });
          const s = stats.get(inst);
          s.sumPct += v.errPct;
          s.sumPts += v.errPts;
          s.n += 1;
        });
      });
      const rows = [];
      stats.forEach((s, inst) => {
        const mape = s.sumPct / s.n;
        const mae = s.sumPts / s.n;
        rows.push({ institution: inst, n: s.n, mape, mae });
      });
      rows.sort((a, b) => (a.mape - b.mape) || (a.mae - b.mae) || a.institution.localeCompare(b.institution));
      return { rows, windowYears };
    }

    // Plugin ligne horizontale (pour le graphe principal)
    const customLine = {
      id: 'customLine',
      afterDatasetsDraw(chart) {
        const opts = chart.options.plugins?.customLine;
        if (!opts || typeof opts.y !== 'number') return;
        const { ctx, chartArea, scales } = chart;
        const yPix = scales.y.getPixelForValue(opts.y);
        ctx.save();
        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = opts.color || '#888';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(chartArea.left, yPix);
        ctx.lineTo(chartArea.right, yPix);
        ctx.stroke();
        ctx.setLineDash([]);
        const label = opts.label || `R√©alit√©: ${opts.y} pts`;
        ctx.fillStyle = opts.labelColor || '#333';
        ctx.font = '12px Segoe UI';
        const tw = ctx.measureText(label).width;
        ctx.fillText(label, chartArea.right - tw - 8, yPix - 6);
        ctx.restore();
      }
    };

    Chart.register(customLine, ChartDataLabels);

    let chartInstance = null;     // graphe principal (barres)
    let predRealChart = null;     // graphe droite (ligne)
    let focusedInstitution = null;
    let currentHorizon = 1;

    function displayTable(year) {
      const data = chartDataByYear[year];
      const canvas = document.getElementById('chartCanvas');
      if (!canvas || !data) {
        if (chartInstance) chartInstance.destroy();
        return;
      }

      const ctx = canvas.getContext('2d');
      const { institutions, previsions, real } = data;

      const base = previsions.map(p => Math.min(p, real));
      const ecarts = previsions.map(p => Math.abs(real - p));
      const signes = previsions.map(p => p - real);

      const pourcentages = signes.map(diff => ((Math.abs(diff) / real) * 100).toFixed(1));

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: institutions,
          datasets: [
            {
              label: 'Pr√©vision',
              data: base,
              backgroundColor: 'rgba(54, 162, 235, 0.85)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              stack: 'grp',
              datalabels: { display: false }
            },
            {
              label: '√âcart vs R√©alit√©',
              data: ecarts,
              backgroundColor: 'rgba(255, 99, 132, 0.65)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
              stack: 'grp',
              datalabels: {
                display: true,
                anchor: 'center',
                align: 'center',
                formatter: (val, ctx) => {
                  const sym = signes[ctx.dataIndex] < 0 ? 'üîª' : 'üî∫';
                  return sym + ' ' + pourcentages[ctx.dataIndex] + '%';
                },
                color: '#fff',
                font: { weight: 'bold', size: 12 },
                clip: true
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `S&P 500 ‚Äì ${year} : Pr√©visions vs R√©alit√© (${real} pts)`,
              font: { size: 18 }
            },
            legend: { position: 'bottom' },
            customLine: {
              y: real,
              color: '#888',
              label: `R√©alit√©: ${real} pts`
            },
            datalabels: { clip: false },
            tooltip: {
              callbacks: {
                afterBody: items => {
                  const idx = items[0].dataIndex;
                  const p = previsions[idx];
                  return `Pr√©vision: ${p} pts | R√©alit√©: ${real} pts`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              title: { display: true, text: 'Institution' }
            },
            y: {
              stacked: true,
              title: { display: true, text: 'Points S&P 500' }
            }
          }
        }
      });

      // Met √† jour l‚Äôanalyse d√©taill√©e
      focusedInstitution = null; // reset
      //renderRankingAndChart(year, currentHorizon);
    }

    function renderRankingAndChart(endYear, horizon) {
      // Boutons d‚Äôhorizon
      document.querySelectorAll('.horizon-tabs button').forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.h) === horizon);
      });

      const { rows, windowYears } = computeRanking(endYear, horizon);
      const tbody = document.querySelector('#rankingTable tbody');
      tbody.innerHTML = '';

      // Choisir institution en focus si non d√©finie
      if (!focusedInstitution && rows.length) focusedInstitution = rows[0].institution;

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        if (r.institution === focusedInstitution) tr.classList.add('focused');
        tr.innerHTML = `
          <td><span class="rank-badge">${idx + 1}</span></td>
          <td>${r.institution}</td>
          <td>${r.n}</td>
          <td>${r.mape.toFixed(1)}%</td>
          
        `;
        tr.addEventListener('click', () => {
          focusedInstitution = r.institution;
          renderRankingAndChart(endYear, horizon); // re-render table to update highlight
        });
        tbody.appendChild(tr);
      });

      // Met √† jour le graphique droite: Pr√©vision vs R√©alit√© par ann√©e pour l‚Äôinstitution focus
      renderPredVsRealChart(focusedInstitution);
    }

    function renderPredVsRealChart(institution) {
      const canvas = document.getElementById('predRealCanvas');
      const ctx = canvas.getContext('2d');

      // Collecte les ann√©es o√π l‚Äôinstitution a une pr√©vision
      const labels = [];
      const preds = [];
      const reals = [];
      yearsSorted.forEach(y => {
        const d = chartDataByYear[y];
        const i = d.institutions.indexOf(institution);
        if (i >= 0) {
          labels.push(y);
          preds.push(d.previsions[i]);
          reals.push(d.real);
        }
      });

      if (predRealChart) predRealChart.destroy();
      predRealChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: `${institution} ‚Äì Pr√©vision`,
              data: preds,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'rgba(54, 162, 235, 0.15)',
              borderWidth: 3,
              pointRadius: 3,
              tension: 0.25
            },
            {
              label: 'R√©alit√©',
              data: reals,
              borderColor: 'rgba(31, 41, 55, 0.9)',
              backgroundColor: 'rgba(31, 41, 55, 0.1)',
              borderWidth: 2,
              pointRadius: 2,
              tension: 0.25
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Pr√©vision vs R√©alit√© ‚Äì ${institution}`,
              font: { size: 16 }
            },
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw} pts`
              }
            },
            datalabels: { display: false }
          },
          scales: {
            x: { title: { display: true, text: 'Ann√©e' } },
            y: { title: { display: true, text: 'Points S&P 500' } }
          }
        }
      });
    }

    // √âcouteurs UI
    document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('yearSelect');
  sel.value = sel.value || '2020';

  // Le graphique principal d√©pend toujours du s√©lecteur
  sel.addEventListener('change', e => {
    displayTable(e.target.value);
  });

  // Affiche le graphique principal pour la valeur par d√©faut
  displayTable(sel.value);

  // Classement et pr√©vision vs r√©alit√© sont toujours bas√©s sur la derni√®re ann√©e
  const latestYear = yearsSorted.at(-1);
  renderRankingAndChart(latestYear, currentHorizon);

  // Boutons d‚Äôhorizon : toujours bas√©s sur latestYear
  document.querySelectorAll('.horizon-tabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      currentHorizon = Number(btn.dataset.h);
      const latestYear = yearsSorted.at(-1);
      renderRankingAndChart(latestYear, currentHorizon);
    });
  });
});
  </script>
</body>
</html>
