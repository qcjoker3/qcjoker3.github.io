<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Finoza - Pr√©dictions</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-calculatrice.css">
</head>
<body>

<header class="container">
    <h1>Finoza</h1>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="#services">Services</a>
        <a href="Pr√©dictions.html">Pr√©dictions</a>
        <a href="calculatrices.html">Calculatrices</a>
        <a href="gestionActive.html">Gestion active</a>
        <a href="#articles">Articles</a>
        <a href="index.html#contact">Contact</a>
    </nav>
</header>

<main class="container">
    <section>
        <div class="encadre-texte">
            √Ä chaque d√©but d'ann√©e les strat√©gistes des grandes banques et fonds d'investissement d√©voilent leurs pr√©dictions sur le S&P 500 pour l'ann√©e √† venir. Ils sont pay√©s des millions par ann√©e et poss√®dent des mod√®les √©conom√©triques tr√®s avanc√©s. Ils devraient √™tre bons, n'est-ce pas‚ÄØ? Pourtant ann√©e apr√®s ann√©e ils sont toujours √† l'emploi de leur firme √† attendre leur ch√®que aux 2 semaines. Charlatants ou experts? Voyez par vous-m√™mes‚ÄØ!
        </div>

        <h2 style="text-align:center;">Pr√©dictions du S&P 500</h2>

        <section class="analysis">
            <h3>Analyse d√©taill√©e</h3>
            <div class="grid-2">
                <div>
                    <h4>Classement des institutions</h4>
                    <div class="horizon-tabs">
                        <button data-h="1" class="active">1 an</button>
                        <button data-h="3">3 ans</button>
                        <button data-h="5">5 ans</button>
                    </div>
                    <div class="hint">Classement par √©cart moyen en % sur l‚Äôhorizon choisi.</div>
                    <div class="table-wrap">
                        <table id="rankingTable">
                            <thead>
                                <tr><th>#</th><th>Institution</th><th>Ann√©es</th><th>√âcart moyen (%)</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h4>Pr√©vision vs R√©alit√© par ann√©e</h4>
                    <div class="hint">S√©lectionnez une ligne du classement pour voir sa trajectoire.</div>
                    <div id="predRealContainer">
                        <canvas id="predRealCanvas"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <div class="year-selector">
            <label for="yearSelect">üìÖ Ann√©e :</label>
            <select id="yearSelect">
                </select>
        </div>

        <div id="chartContainer">
            <canvas id="chartCanvas"></canvas>
        </div>
    </section>
</main>

<footer>
    <p>&copy; 2025 - Finoza</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
    // ==========================================================
    // DONN√âES
    // ==========================================================
    const chartDataByYear = {
        "2020": { real: 3756, institutions: ["Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC", "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"], previsions: [3400, 3400, 3300, 3000, 3000, 3300, 3300, 3350, 3250, 3425, 3400, 3500] },
        "2021": { real: 4766, institutions: ["Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC", "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"], previsions: [4300, 4400, 3800, 3900, 4100, 4000, 4000, 4100, 3950, 4050, 4200, 4300] },
        "2022": { real: 3840, institutions: ["Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC", "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"], previsions: [5100, 5050, 4600, 4400, 4850, 5300, 4800, 5050, 5250, 5200, 5300, 5330] },
        "2023": { real: 4770, institutions: ["Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC", "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"], previsions: [4000, 4200, 4000, 3900, 3900, 4400, 4150, 4300, 4500, 4050, 4300, 4400] },
        "2024": { real: 5882, institutions: ["Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC", "Deutsche Bank", "BCA Research", "BMO", "Oppenheimer"], previsions: [5100, 4200, 5000, 4500, 4700, 4700, 5300, 5000, 5100, 3300, 5100, 5200] },
    };

    // ==========================================================
    // SETUP INITIAL
    // ==========================================================
    const yearSelect = document.getElementById('yearSelect');
    const rankingTbody = document.querySelector('#rankingTable tbody');
    const horizonTabs = document.querySelectorAll('.horizon-tabs button');

    let chartInstance = null;
    let predRealChart = null;
    let focusedInstitution = null;
    let currentHorizon = 1;

    const realityLinePlugin = { id: 'realityLine', afterDatasetsDraw(chart) { const { ctx, chartArea, scales } = chart; const yValue = chart.options.plugins?.realityLine?.y; if (typeof yValue !== 'number') return; const yPixel = scales.y.getPixelForValue(yValue); ctx.save(); ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 2; ctx.setLineDash([6, 6]); ctx.beginPath(); ctx.moveTo(chartArea.left, yPixel); ctx.lineTo(chartArea.right, yPixel); ctx.stroke(); ctx.restore(); ctx.font = 'bold 12px "Segoe UI"'; ctx.fillStyle = '#4b5563'; ctx.textAlign = 'right'; ctx.fillText(`R√©alit√©: ${yValue}`, chartArea.right - 5, yPixel - 8); } };
    Chart.register(realityLinePlugin, ChartDataLabels);

    // ==========================================================
    // FONCTIONS DE MISE √Ä JOUR DE L'INTERFACE
    // ==========================================================
    function updateMainChart(year) {
        const data = chartDataByYear[year];
        const canvas = document.getElementById('chartCanvas');
        if (!canvas || !data) return;
        if (chartInstance) chartInstance.destroy();
        const { institutions, previsions, real } = data;
        const base = previsions.map(p => Math.min(p, real));
        const ecarts = previsions.map(p => Math.abs(real - p));
        const signes = previsions.map(p => p >= real);
        chartInstance = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels: institutions, datasets: [{ label: 'Pr√©vision', data: base, backgroundColor: 'rgba(54, 162, 235, 0.85)', stack: 'group' }, { label: '√âcart vs R√©alit√©', data: ecarts, backgroundColor: 'rgba(255, 99, 132, 0.65)', stack: 'group' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `S&P 500 ‚Äì ${year} : Pr√©visions vs R√©alit√© (${real} pts)`, font: { size: 18 } }, legend: { position: 'bottom' }, realityLine: { y: real }, datalabels: { display: (c) => c.datasetIndex === 1, anchor: 'center', align: 'center', color: 'white', font: { weight: 'bold' }, formatter: (v, c) => (signes[c.dataIndex] ? 'üî∫' : 'üîª') + ` ${(v / real * 100).toFixed(1)}%` } } , scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Points S&P 500' } } } } });
    }

    function updateRankingAndDetail(endYear, horizon) {
        const years = Object.keys(chartDataByYear).sort();
        const endIdx = years.indexOf(String(endYear));
        const startIdx = Math.max(0, endIdx - (horizon - 1));
        const windowYears = years.slice(startIdx, endIdx + 1);
        const stats = {};
        windowYears.forEach(y => { const d = chartDataByYear[y]; d.institutions.forEach((inst, i) => { if (!stats[inst]) stats[inst] = { sumErr: 0, count: 0 }; stats[inst].sumErr += Math.abs(d.previsions[i] - d.real) / d.real * 100; stats[inst].count++; }); });
        const ranking = Object.entries(stats).map(([institution, data]) => ({ institution, avgErr: data.sumErr / data.count, n: data.count })).sort((a, b) => a.avgErr - b.avgErr);
        rankingTbody.innerHTML = '';
        if (!focusedInstitution && ranking.length > 0) focusedInstitution = ranking[0].institution;
        ranking.forEach((r, i) => { const tr = document.createElement('tr'); tr.className = r.institution === focusedInstitution ? 'focused' : ''; tr.innerHTML = `<td><span class="rank-badge">${i + 1}</span></td><td>${r.institution}</td><td>${r.n}</td><td>${r.avgErr.toFixed(1)}%</td>`; tr.onclick = () => { focusedInstitution = r.institution; updateRankingAndDetail(endYear, horizon); }; rankingTbody.appendChild(tr); });
        updatePredVsRealChart(focusedInstitution);
    }

    function updatePredVsRealChart(institution) {
        if (!institution) return;
        const canvas = document.getElementById('predRealCanvas');
        if (predRealChart) predRealChart.destroy();
        const labels = [], preds = [], reals = [];
        Object.keys(chartDataByYear).sort().forEach(y => { const d = chartDataByYear[y]; const i = d.institutions.indexOf(institution); if (i > -1) { labels.push(y); preds.push(d.previsions[i]); reals.push(d.real); } });
        predRealChart = new Chart(canvas.getContext('2d'), { type: 'line', data: { labels, datasets: [{ label: `${institution} ‚Äì Pr√©vision`, data: preds, borderColor: 'rgba(54, 162, 235, 1)', tension: 0.1 }, { label: 'R√©alit√©', data: reals, borderColor: 'rgba(31, 41, 55, 0.9)', tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Pr√©vision vs R√©alit√© ‚Äì ${institution}`, font: { size: 16 } }, legend: { position: 'bottom' }, datalabels: { display: false } }, scales: { y: { title: { display: true, text: 'Points S&P 500' } } } } });
    }

    // ==========================================================
    // √âV√âNEMENTS ET INITIALISATION
    // ==========================================================
    yearSelect.addEventListener('change', (e) => {
        updateMainChart(e.target.value);
    });

    horizonTabs.forEach(btn => {
        btn.addEventListener('click', () => {
            horizonTabs.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentHorizon = Number(btn.dataset.h);
            const latestYear = Object.keys(chartDataByYear).sort().pop();
            updateRankingAndDetail(latestYear, currentHorizon);
        });
    });

    function initialize() {
        const years = Object.keys(chartDataByYear).sort();
        years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });
        
        const latestYear = years[years.length - 1];
        yearSelect.value = latestYear;
        updateMainChart(latestYear);
        updateRankingAndDetail(latestYear, currentHorizon);
    }

    initialize(); // Lance l'application
</script>

</body>
</html>
