<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Graphique multi-années – S&P 500</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      text-align: center;
      padding: 40px;
    }
    canvas {
      max-width: 900px;
      margin: 30px auto;
      display: block;
    }
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .controls button {
      font-size: 1em;
      padding: 8px 16px;
      cursor: pointer;
    }
    .year-label {
      font-size: 1.2em;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>Prévisions vs Réalité du S&P 500</h2>

<div class="controls">
  <button id="prevYear">← Année précédente</button>
  <span class="year-label" id="currentYearLabel">2020</span>
  <button id="nextYear">Année suivante →</button>
</div>

<canvas id="graphiqueSP500"></canvas>

<script>
  const dataByYear = {
    "2020": {
      real: 3756,
      institutions: [
        "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS",
        "Wells Fargo", "Barclays", "RBC", "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
      ],
      previsions: [3400, 3400, 3300, 3000, 3000, 3300, 3300, 3350, 3250, 3425, 3400, 3500]
    },
    "2021": {
      real: 4766,
      institutions: ["JP Morgan", "Goldman Sachs", "Oppenheimer", "Credit Suisse"],
      previsions: [3900, 4050, 4200, 4000]
    }
    // Ajoute ici d'autres années si nécessaire
  };

  let chartInstance;
  let yearIndex = 0;
  const yearList = Object.keys(dataByYear);
  const yearLabel = document.getElementById("currentYearLabel");

  function renderChart(year) {
    const { institutions, previsions, real } = dataByYear[year];
    const ecarts = previsions.map(p => real - p);

    const ctx = document.getElementById('graphiqueSP500').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: institutions,
        datasets: [
          {
            label: 'Prévision',
            data: previsions,
            backgroundColor: 'rgba(54, 162, 235, 0.7)'
          },
          {
            label: 'Écart vers Réalité',
            data: ecarts,
            backgroundColor: 'rgba(255, 99, 132, 0.7)'
          }
        ]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: `Prévisions vs Résultat du S&P 500 (${year})`,
            font: { size: 18 }
          },
          legend: { position: 'bottom' },
          annotation: {
            annotations: {
              ligneReelle: {
                type: 'line',
                yMin: real,
                yMax: real,
                borderColor: 'gray',
                borderWidth: 2,
                label: {
                  enabled: true,
                  content: `Résultat Réel: ${real} pts`,
                  backgroundColor: '#444',
                  color: 'white',
                  position: 'start'
                }
              }
            }
          }
        },
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            title: { display: true, text: 'Points S&P 500' }
          },
          x: {
            title: { display: true, text: 'Institution' }
          }
        }
      },
      plugins: [Chart.registry.getPlugin('annotation')]
    });

    yearLabel.textContent = year;
  }

  document.getElementById('prevYear').addEventListener('click', () => {
    if (yearIndex > 0) {
      yearIndex--;
      renderChart(yearList[yearIndex]);
    }
  });

  document.getElementById('nextYear').addEventListener('click', () => {
    if (yearIndex < yearList.length - 1) {
      yearIndex++;
      renderChart(yearList[yearIndex]);
    }
  });

  // Initialisation
  renderChart(yearList[yearIndex]);
</script>

</body>
</html>
