<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Pr√©dictions</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .encadre-texte {
      font-size: 1.1em;
      width: 60%;
      margin: 20px auto;
      padding: 15px;
      text-align: center;
      background-color: #f7f9fa;
      border-radius: 8px;
    }
    .year-selector { text-align: center; margin: 20px 0; }
    #chartContainer { max-width: 960px; margin: auto; }
    #chartCanvas { width: 100%; height: 420px; }
    footer { text-align: center; margin-top: 40px; }

    /* Analyse d√©taill√©e */
    .analysis {
      max-width: 960px;
      margin: 28px auto 60px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    .analysis h3 { margin: 14px 0; }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 9px 10px; border-bottom: 1px solid #eceff3; text-align: left; }
    th { background: #f7f9fa; position: sticky; top: 0; z-index: 1; }
    .table-wrap { max-height: 340px; overflow: auto; border: 1px solid #eceff3; border-radius: 8px; }
    .rank-badge {
      display: inline-block; min-width: 26px; text-align: center; padding: 2px 6px; border-radius: 999px;
      background: #eef2ff; color: #3730a3; font-weight: 600; font-size: 12px;
    }
    tr.focused { background: #fff7ed; } /* survol/clic */
    tr:hover { background: #f9fafb; cursor: pointer; }

    #errorTrendContainer { max-width: 960px; margin: 6px auto; }
    #errorTrendCanvas { width: 100%; height: 360px; }

    .hint { color: #6b7280; font-size: 0.9em; margin: 6px 0 12px; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section>
      <div class="encadre-texte">
        √Ä chaque d√©but d'ann√©e les strat√©gistes des grandes banques et fonds d'investissement d√©voilent leurs pr√©dictions sur le S&P 500 pour l'ann√©e √† venir. Ils sont pay√©s des millions par ann√©e et poss√®dent des mod√®les √©conom√©triques tr√®s avanc√©s. Ils devraient √™tre bons, n'est-ce pas‚ÄØ? Pourtant ann√©e apr√®s ann√©e ils sont toujours √† l'emploi de leur firme √† attendre leur ch√®que aux 2 semaines. Charlatants ou experts? Voyez par vous-m√™mes‚ÄØ!
      </div>

      <h2 style="text-align:center;">Pr√©dictions du S&P 500</h2>

      <div class="year-selector">
        <label for="yearSelect">üìÖ Ann√©e :</label>
        <select id="yearSelect">
          <option value="">-- S√©lectionner --</option>
          <option value="2020">2020</option>
          <option value="2021">2021</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
        </select>
      </div>

      <div id="chartContainer">
        <canvas id="chartCanvas"></canvas>
      </div>

      <!-- Analyse d√©taill√©e -->
      <section class="analysis">
        <h3>Analyse d√©taill√©e</h3>
        <div class="grid-2">
          <div>
            <h4>Classement des institutions (√©cart le plus petit)</h4>
            <div class="hint">Astuce: clique une ligne pour mettre l‚Äôinstitution en √©vidence dans le graphique de droite.</div>
            <div class="table-wrap">
              <table id="rankingTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Institution</th>
                    <th>Pr√©vision</th>
                    <th>R√©alit√©</th>
                    <th>√âcart (pts)</th>
                    <th>√âcart (%)</th>
                  </tr>
                </thead>
                <tbody><!-- rempli par JS --></tbody>
              </table>
            </div>
          </div>
          <div>
            <h4>√âcart des pr√©visions dans le temps</h4>
            <div class="hint">√âcart relatif (|pr√©vision - r√©alit√©| / r√©alit√©). L‚Äôinstitution en vedette est en couleur vive.</div>
            <div id="errorTrendContainer">
              <canvas id="errorTrendCanvas"></canvas>
            </div>
          </div>
        </div>
      </section>
      <!-- fin Analyse d√©taill√©e -->

    </section>
  </main>

  <footer>
    <p>&copy; 2025 - Finoza</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script>
    fetch('header.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('header-placeholder').innerHTML = data;
      });

    // Donn√©es
    const chartDataByYear = {
      "2020": {
        real: 3756,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          3400, 3400, 3300, 3000, 3000, 3300, 3300, 3350, 3250, 3425, 3400, 3500
        ]
      },
      "2021": {
        real: 4766,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          4300, 4400, 3800, 3900, 4100, 4000, 4000, 4100, 3950, 4050, 4200, 4300
        ]
      },
      "2022": {
        real: 3840,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          5100, 5050, 4600, 4400, 4850, 5300, 4800, 5050, 5250, 5200, 5300, 5330
        ]
      },
      "2023": {
        real: 4770,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          4000, 4200, 4000, 3900, 3900, 4400, 4150, 4300, 4500, 4050, 4300, 4400
        ]
      },
      "2024": {
        real: 5882,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "BCA Research", "BMO", "Oppenheimer"
        ],
        previsions: [
          5100, 4200, 5000, 4500, 4700, 4700, 5300, 5000, 5100, 3300, 5100, 5200
        ]
      },
    };

    // Plugin ligne horizontale
    const customLine = {
      id: 'customLine',
      afterDatasetsDraw(chart) {
        const opts = chart.options.plugins?.customLine;
        if (!opts || typeof opts.y !== 'number') return;
        const { ctx, chartArea, scales } = chart;
        const yPix = scales.y.getPixelForValue(opts.y);
        ctx.save();
        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = opts.color || '#888';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(chartArea.left, yPix);
        ctx.lineTo(chartArea.right, yPix);
        ctx.stroke();
        ctx.setLineDash([]);
        const label = opts.label || `R√©alit√©: ${opts.y} pts`;
        ctx.fillStyle = opts.labelColor || '#333';
        ctx.font = '12px Segoe UI';
        const tw = ctx.measureText(label).width;
        ctx.fillText(label, chartArea.right - tw - 8, yPix - 6);
        ctx.restore();
      }
    };

    Chart.register(customLine, ChartDataLabels);
    let chartInstance = null;
    let errorTrendChart = null;
    let focusedInstitution = null; // institution mise en √©vidence (par d√©faut: meilleure de l'ann√©e)

    // Construire les s√©ries d'√©cart (%) par institution √† travers les ann√©es
    const years = Object.keys(chartDataByYear).sort();
    const errorSeriesByInst = (() => {
      const map = new Map(); // inst -> { years: [], errorsPct: [] }
      years.forEach(y => {
        const d = chartDataByYear[y];
        d.institutions.forEach((inst, i) => {
          const prev = d.previsions[i];
          const real = d.real;
          const errPct = Math.abs(prev - real) / real * 100;
          if (!map.has(inst)) map.set(inst, { years: [], errorsPct: [] });
          map.get(inst).years.push(y);
          map.get(inst).errorsPct.push(errPct);
        });
      });
      return map;
    })();

    function computeRanking(year) {
      const d = chartDataByYear[year];
      const { institutions, previsions, real } = d;
      const rows = institutions.map((inst, i) => {
        const p = previsions[i];
        const diff = Math.abs(p - real);
        const diffPct = diff / real * 100;
        return {
          institution: inst,
          prediction: p,
          real,
          diffPoints: diff,
          diffPct
        };
      });
      rows.sort((a, b) => a.diffPoints - b.diffPoints);
      return rows;
    }

    function renderRankingTable(year) {
      const tbody = document.querySelector('#rankingTable tbody');
      tbody.innerHTML = '';
      const rows = computeRanking(year);
      // D√©termine l'institution en vedette par d√©faut si aucune focalisation utilisateur
      if (!focusedInstitution) focusedInstitution = rows[0]?.institution;

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        if (r.institution === focusedInstitution) tr.classList.add('focused');
        tr.innerHTML = `
          <td><span class="rank-badge">${idx + 1}</span></td>
          <td>${r.institution}</td>
          <td>${r.prediction}</td>
          <td>${r.real}</td>
          <td>${r.diffPoints.toFixed(0)}</td>
          <td>${r.diffPct.toFixed(1)}%</td>
        `;
        tr.addEventListener('click', () => {
          focusedInstitution = r.institution;
          renderRankingTable(year); // rafra√Æchit l‚Äô√©tat "focused"
          renderErrorTrend();       // met √† jour le graphique temporel
        });
        tbody.appendChild(tr);
      });
    }

    function renderErrorTrend() {
      const canvas = document.getElementById('errorTrendCanvas');
      const ctx = canvas.getContext('2d');

      // Pr√©pare labels: toutes les ann√©es uniques
      const labels = years;

      // Palette et styles
      const colorFocused = 'rgba(234, 88, 12, 1)';   // orange vif
      const colorOthers  = 'rgba(100, 116, 139, 0.35)'; // slate/gris att√©nu√©

      // Construit les datasets: chaque institution
      const datasets = [];
      for (const [inst, series] of errorSeriesByInst.entries()) {
        // Remplir les donn√©es align√©es sur "years" (NaN si ann√©e absente)
        const data = labels.map(y => {
          const idx = series.years.indexOf(y);
          return idx >= 0 ? series.errorsPct[idx] : null;
        });
        const isFocus = inst === focusedInstitution;
        datasets.push({
          label: inst,
          data,
          borderColor: isFocus ? colorFocused : colorOthers,
          backgroundColor: 'transparent',
          borderWidth: isFocus ? 3 : 1.2,
          pointRadius: isFocus ? 3 : 0,
          pointHoverRadius: isFocus ? 5 : 3,
          tension: 0.25,
          spanGaps: true,
          hidden: false
        });
      }

      if (errorTrendChart) errorTrendChart.destroy();
      errorTrendChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `√âcart des pr√©visions dans le temps (en % du niveau r√©el)`,
              font: { size: 16 }
            },
            legend: {
              position: 'bottom',
              labels: {
                filter: (item) => {
                  // On r√©duit la surcharge visuelle en n'affichant que l‚Äôinstitution en focus + quelques autres au besoin
                  // Ici: on affiche toutes dans la l√©gende; adapte si tu veux la restreindre.
                  return true;
                }
              }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw;
                  return `${ctx.dataset.label}: ${v == null ? '‚Äî' : v.toFixed(1) + '%'}`;
                }
              }
            },
            datalabels: { display: false }
          },
          scales: {
            y: {
              title: { display: true, text: '√âcart (%)' },
              ticks: { callback: v => v + ' %' }
            },
            x: {
              title: { display: true, text: 'Ann√©e' }
            }
          }
        }
      });
    }

    function displayTable(year) {
      const data = chartDataByYear[year];
      const canvas = document.getElementById('chartCanvas');
      if (!canvas || !data) {
        if (chartInstance) chartInstance.destroy();
        return;
      }

      const ctx = canvas.getContext('2d');
      const { institutions, previsions, real } = data;

      const base = previsions.map(p => Math.min(p, real));
      const ecarts = previsions.map(p => Math.abs(real - p));
      const signes = previsions.map(p => p - real);

      const pourcentages = signes.map(diff =>
        ((Math.abs(diff) / real) * 100).toFixed(1)
      );

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: institutions,
          datasets: [
            {
              label: 'Pr√©vision',
              data: base,
              backgroundColor: 'rgba(54, 162, 235, 0.85)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              stack: 'grp',
              datalabels: { display: false }
            },
            {
              label: '√âcart vs R√©alit√©',
              data: ecarts,
              backgroundColor: 'rgba(255, 99, 132, 0.65)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
              stack: 'grp',
              datalabels: {
                display: true,
                anchor: 'center',
                align: 'center',
                formatter: (val, ctx) => {
                  const sym = signes[ctx.dataIndex] < 0 ? 'üîª' : 'üî∫';
                  return sym + ' ' + pourcentages[ctx.dataIndex] + '%';
                },
                color: '#fff',
                font: { weight: 'bold', size: 12 },
                clip: true
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `S&P 500 ‚Äì ${year} : Pr√©visions vs R√©alit√© (${real} pts)`,
              font: { size: 18 }
            },
            legend: { position: 'bottom' },
            customLine: {
              y: real,
              color: '#888',
              label: `R√©alit√©: ${real} pts`
            },
            datalabels: { clip: false },
            tooltip: {
              callbacks: {
                afterBody: items => {
                  const idx = items[0].dataIndex;
                  const p = previsions[idx];
                  return `Pr√©vision: ${p} pts | R√©alit√©: ${real} pts`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              title: { display: true, text: 'Institution' }
            },
            y: {
              stacked: true,
              title: { display: true, text: 'Points S&P 500' }
            }
          }
        }
      });

      // Met √† jour l‚Äôanalyse d√©taill√©e (classement + tendance)
      focusedInstitution = null;           // reset focus √† chaque changement d'ann√©e
      renderRankingTable(year);            // calcule et met en √©vidence la meilleure
      renderErrorTrend();                  // trace la tendance avec focus
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sel = document.getElementById('yearSelect');
      sel.value = sel.value || '2020';
      displayTable(sel.value);
      sel.addEventListener('change', e => displayTable(e.target.value));
    });
  </script>
</body>
</html>
