<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Pr√©dictions</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .encadre-texte {
      font-size: 1.1em;
      width: 60%;
      margin: 20px auto;
      padding: 15px;
      text-align: center;
      background-color: #f0f8ff;
      border-radius: 8px;
    }
    .year-selector { text-align: center; margin: 20px 0; }
    #chartContainer { max-width: 960px; margin: auto; }
    #chartCanvas { width: 100%; height: 420px; }
    footer { text-align: center; margin-top: 40px; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section>
      <div class="encadre-texte">
        √Ä chaque d√©but d'ann√©e les strat√©gistes des grandes banques et fonds d'investissement d√©voilent leurs pr√©dictions sur le S&P 500 pour l'ann√©e √† venir. Ils sont pay√©s des millions par ann√©e et poss√®dent des mod√®les √©conom√©triques tr√®s avanc√©s. Ils devraient √™tre bons, n'est-ce pas‚ÄØ? Pourtant ann√©e apr√®s ann√©e ils sont toujours √† l'emploi de leur firme √† attendre leur ch√®que aux 2 semaines. Charlatants ou experts? Voyez par vous-m√™mes‚ÄØ!
      </div>

      <h2 style="text-align:center;">Pr√©dictions du S&P 500</h2>

      <div class="year-selector">
        <label for="yearSelect">üìÖ Ann√©e :</label>
        <select id="yearSelect">
          <option value="">-- S√©lectionner --</option>
          <option value="2020">2020</option>
          <option value="2021">2021</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
        </select>
      </div>

      <div id="chartContainer">
        <canvas id="chartCanvas"></canvas>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 - Finoza</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script>
    // Injection du header
    fetch('header.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('header-placeholder').innerHTML = data;
      })
      .catch(error => console.error('Erreur de chargement du header :', error));

    // Donn√©es
    const chartDataByYear = {
      "2020": {
        real: 3756,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          3400, 3400, 3300, 3000, 3000, 3300, 3300, 3350, 3250, 3425, 3400, 3500
        ]
      },
      "2021": {
        real: 4766,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          4300, 4400, 3800, 3900, 4100, 4000, 4000, 4100, 3950, 4050, 4200, 4300
        ]
      },
      "2022": {
        real: 3840,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          5100, 5050, 4600, 4400, 4850, 5300, 4800, 5050, 5250, 5200, 5300, 5330
        ]
      },
      "2023": {
        real: 4770,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "Credit Suisse", "BMO", "Oppenheimer"
        ],
        previsions: [
          4000, 4200, 4000, 3900, 3900, 4400, 4150, 4300, 4500, 4050, 4300, 4400
        ]
      },
      "2024": {
        real: 5882,
        institutions: [
          "Goldman Sachs", "JP Morgan", "Bank of America", "Morgan Stanley", "UBS", "Wells Fargo", "Barclays", "RBC",
          "Deutsche Bank", "BCA Research", "BMO", "Oppenheimer"
        ],
        previsions: [
          5100, 4200, 5000, 4500, 4700, 4700, 5300, 5000, 5100, 3300, 5100, 5200
        ]
      },
    };

    // Plugin ligne horizontale
    const customLine = {
      id: 'customLine',
      afterDatasetsDraw(chart) {
        const opts = chart.options.plugins?.customLine;
        if (!opts || typeof opts.y !== 'number') return;
        const { ctx, chartArea, scales } = chart;
        const yPix = scales.y.getPixelForValue(opts.y);
        ctx.save();
        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = opts.color || '#888';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(chartArea.left, yPix);
        ctx.lineTo(chartArea.right, yPix);
        ctx.stroke();
        ctx.setLineDash([]);
        const label = opts.label || `R√©alit√©: ${opts.y} pts`;
        ctx.fillStyle = opts.labelColor || '#333';
        ctx.font = '12px Segoe UI';
        const tw = ctx.measureText(label).width;
        ctx.fillText(label, chartArea.right - tw - 8, yPix - 6);
        ctx.restore();
      }
    };

    Chart.register(customLine, ChartDataLabels);

    let chartInstance = null;

    function displayTable(year) {
      const data = chartDataByYear[year];
      const canvas = document.getElementById('chartCanvas');
      if (!canvas || !data) {
        if (chartInstance) chartInstance.destroy();
        return;
      }

      const ctx = canvas.getContext('2d');
      const { institutions, previsions, real } = data;

      const base = previsions.map(p => Math.min(p, real));
      const ecarts = previsions.map(p => Math.abs(p - real));
      const start = previsions.map(p => Math.min(p, real));
      const signe = previsions.map(p => p - real);

      const pourcentages = signe.map(diff => {
        return ((Math.abs(diff) / real) * 100).toFixed(1);
      });

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: institutions,
          datasets: [
            {
              label: 'Pr√©vision (jusqu‚Äô√† la r√©alit√©)',
              data: base,
              backgroundColor: 'rgba(54, 162, 235, 0.85)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              stack: 'grp',
              datalabels: { display: false }
            },
            {
              label: '√âcart vs R√©alit√©',
              data: ecarts,
              backgroundColor: 'rgba(255, 99, 132, 0.65)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
              stack: 'grp',
              base: start,
              datalabels: {
                display: true,
                anchor: 'center',
                align: 'center',
                formatter: (val, ctx) => {
                  const sym = signe[ctx.dataIndex] < 0 ? 'üîª' : 'üî∫';
                  return sym + ' ' + pourcentages[ctx.dataIndex] + '%';
                },
                color: '#fff',
                font: { weight: 'bold', size: 12 },
                clip: true
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `S&P 500 ‚Äì ${year} : Pr√©visions vs R√©alit√© (${real} pts)`,
              font: { size: 18 }
            },
            legend: { position: 'bottom' },
            customLine: {
              y: real,
              color: '#888',
              label: `R√©alit√©: ${real} pts`
            },
            datalabels: {
              clip: false
            },
            tooltip: {
              callbacks: {
                afterBody: items => {
                  const idx = items[0].dataIndex;
                  const p = previsions[idx];
                  return `Pr√©vision: ${p} pts | R√©alit√©: ${real} pts`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              title: { display: true, text: 'Institution' }
            },
            y: {
              stacked: true,
              title: { display: true, text: 'Points S&P 500' }
            }
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const sel = document.getElementById('yearSelect');
      sel.value = sel.value || '2020';
      displayTable(sel.value);
      sel.addEventListener('change', e => displayTable(e.target.value));
    });
  </script>
</body>
</html>
